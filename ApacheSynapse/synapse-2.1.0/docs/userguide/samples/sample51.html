<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 6, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>
        Apache Synapse - Sample 51</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120106" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Apache Synapse
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-01-06</span>
                  &nbsp;| <span id="projectVersion">Version: 2.1.0</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Main Menu</h5>
                  <ul>
                  <li class="none">
                          <a href="../../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="../../download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../../history.html" title="History">History</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
                          <a href="../../userguide/installation.html" title="Installation Guide">Installation Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/quick_start.html" title="Quick Start Guide">Quick Start Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples/setup/index.html" title="Samples Setup Guide">Samples Setup Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples.html" title="Samples Catalog">Samples Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/config.html" title="Configuration Language">Configuration Language</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/mediators.html" title="Mediators Catalog">Mediators Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/transports.html" title="Transports Catalog">Transports Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/extending.html" title="Extending Synapse">Extending Synapse</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/upgrading.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/deployment.html" title="Deployment">Deployment</a>
            </li>
                  <li class="none">
                          <a href="../../apidocs/" title="Javadocs">Javadocs</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                       <h5>Developer Resources</h5>
                  <ul>
                  <li class="none">
                          <a href="../../dev/developer-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
                  <li class="none">
                          <a href="../../dev/best-practices.html" title="Development Best Practices">Development Best Practices</a>
            </li>
                  <li class="none">
                          <a href="../../dev/release-process.html" title="Release Process">Release Process</a>
            </li>
          </ul>
                       <h5>Project Details</h5>
                  <ul>
                  <li class="none">
                          <a href="../../project-info.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../../mail-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../../source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                  <li class="none">
                          <a href="../../issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                  <li class="none">
                          <a href="../../dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                  <li class="none">
                          <a href="../../team-list.html" title="Project Team">Project Team</a>
            </li>
                  <li class="none">
                          <a href="../../project-summary.html" title="Project Summary">Project Summary</a>
            </li>
          </ul>
                       <h5>Previous Releases</h5>
                  <ul>
                  <li class="none">
                          <a href="../../1_2/docs_index.html" title="Version 1.2">Version 1.2</a>
            </li>
                  <li class="none">
                          <a href="../../1_1_1/content.html" title="Version 1.1.1">Version 1.1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_1/content.html" title="Version 1.1">Version 1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_0/content.html" title="Version 1.0">Version 1.0</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- ~  Licensed to the Apache Software Foundation (ASF) under one
  ~  or more contributor license agreements.  See the NOTICE file
  ~  distributed with this work for additional information
  ~  regarding copyright ownership.  The ASF licenses this file
  ~  to you under the Apache License, Version 2.0 (the
  ~  "License"); you may not use this file except in compliance
  ~  with the License.  You may obtain a copy of the License at
  ~
  ~   http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing,
  ~  software distributed under the License is distributed on an
  ~   * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~  KIND, either express or implied.  See the License for the
  ~  specific language governing permissions and limitations
  ~  under the License. -->
    
        <div class="section"><h2>Sample 51: MTOM and SwA Optimizations and Request/Response Correlation<a name="Sample_51:_MTOM_and_SwA_Optimizations_and_RequestResponse_Correlation"></a></h2>
            <div class="xmlConf">&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingMTOM&quot;&gt;
                &lt;then&gt;
                    &lt;property name=&quot;example&quot; value=&quot;mtom&quot;/&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;
                                     optimize=&quot;mtom&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/then&gt;
            &lt;/filter&gt;
            &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingSwA&quot;&gt;
                &lt;then&gt;
                    &lt;property name=&quot;example&quot; value=&quot;swa&quot;/&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/services/MTOMSwASampleService&quot;
                                     optimize=&quot;swa&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/then&gt;
            &lt;/filter&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;filter source=&quot;get-property('example')&quot; regex=&quot;mtom&quot;&gt;
                &lt;then&gt;
                    &lt;property name=&quot;enableMTOM&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;
                &lt;/then&gt;
            &lt;/filter&gt;
            &lt;filter source=&quot;get-property('example')&quot; regex=&quot;swa&quot;&gt;
                &lt;then&gt;
                    &lt;property name=&quot;enableSwA&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;
                &lt;/then&gt;
            &lt;/filter&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</div>
            <div class="section"><h3>Objective<a name="Objective"></a></h3>
                <p>
                    Demonstrate the use of content optimization mechanisms like MTOM and SwA with
                    Synapse.
                </p>
            </div>
            <div class="section"><h3>Pre-requisites<a name="Pre-requisites"></a></h3>
                <p>
                    </p><ul>
                        <li>
                            Deploy the MTOMSwASampleService in the sample Axis2 server and start Axis2
                        </li>
                        <li>
                            Start Synapse using the configuration numbered 51 (repository/conf/sample/synapse_sample_51.xml)
                            <div class="command">
                                Unix/Linux: sh synapse.sh -sample 51<br />
                                Windows: synapse.bat -sample 51
                            </div>
                        </li>
                    </ul>
                
            </div>
            <div class="section"><h3>Executing the Client<a name="Executing_the_Client"></a></h3>
                <p>
                    Execute the client as follows to send a MTOM optimized request to Synapse.
                </p>                
                <div class="command">ant optimizeclient -Dopt_mode=mtom</div>
                <p>
                    Synapse sets a local message context property, and forwards the message to
                    'http://localhost:9000/services/MTOMSwASampleService', while optimizing binary
                    content as MTOM. By sending this message through TCPMon you will be able to see
                    the actual message sent by Synapse if required.
                </p>
                <div class="consoleOutput">POST /services/MTOMSwASampleService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:uploadFileUsingMTOM
Content-Type: multipart/related; boundary=MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353; type=&quot;application/xop+xml&quot;;
start=&quot;&lt;0.urn:uuid:B94996494E1DD5F9B51177413845354@apache.org&gt;&quot;; start-info=&quot;text/xml&quot;; charset=UTF-8
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353241
Content-Type: application/xop+xml; charset=UTF-8; type=&quot;text/xml&quot;
Content-Transfer-Encoding: binary
Content-ID:
   &lt;0.urn:uuid:B94996494E1DD5F9B51177413845354@apache.org&gt;221b1
      &lt;?xml version='1.0' encoding='UTF-8'?&gt;
         &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
            &lt;soapenv:Body&gt;
               &lt;m0:uploadFileUsingMTOM xmlns:m0=&quot;http://www.apache-synapse.org/test&quot;&gt;
                  &lt;m0:request&gt;
                     &lt;m0:image&gt;
                        &lt;xop:Include href=&quot;cid:1.urn:uuid:78F94BC50B68D76FB41177413845003@apache.org&quot; xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; /&gt;
                     &lt;/m0:image&gt;
                  &lt;/m0:request&gt;
               &lt;/m0:uploadFileUsingMTOM&gt;
            &lt;/soapenv:Body&gt;
         &lt;/soapenv:Envelope&gt;
--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353217
Content-Type: image/gif
Content-Transfer-Encoding: binary
Content-ID:
         &lt;1.urn:uuid:78F94BC50B68D76FB41177413845003@apache.org&gt;22800GIF89a... &lt;&lt; binary content &gt;&gt;</div>
                <p>
                    During response processing, by checking the local message property Synapse can
                    discover past information about the current message context, and use this
                    knowledge to send the response back to the client in the same format as the
                    original request.
                </p>
                <p>
                    When the client executes successfully, it will upload a file containing the ASF
                    logo and receive a response which is savesd a temporary file.
                </p>
                <div class="consoleOutput">[java] Sending file : ./../../repository/conf/sample/resources/mtom/asf-logo.gif as MTOM
[java] Saved response to file : ./../../work/temp/sampleClient/mtom-4417.gif</div>

                <p>
                    Now invoke the client as follows to send a SwA optimized request.
                </p>
                <div class="command">ant optimizeclient -Dopt_mode=swa</div>
                <p>
                    This is identical to the previous invocation with only difference being the use
                    of SwA (SOAP with Attachement) instead of MTOM for content optimization. You
                    will get an output similar to following.
                </p>
                <div class="consoleOutput">[java] Sending file : ./../../repository/conf/sample/resources/mtom/asf-logo.gif as SwA
[java] Saved response to file : ./../../work/temp/sampleClient/swa-30391.gif</div>
                <p>
                    By using TCPMon and sending the message through it, one can see that the
                    requests and responses sent are indeed sent as HTTP attachments as follows.
                </p>

                <div class="consoleOutput">POST /services/MTOMSwASampleService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:uploadFileUsingSwA
Content-Type: multipart/related; boundary=MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177414170491; type=&quot;text/xml&quot;;
start=&quot;&lt;0.urn:uuid:B94996494E1DD5F9B51177414170492@apache.org&gt;&quot;; charset=UTF-8
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177414170491225
Content-Type: text/xml; charset=UTF-8
Content-Transfer-Encoding: 8bit
Content-ID:
   &lt;0.urn:uuid:B94996494E1DD5F9B51177414170492@apache.org&gt;22159
      &lt;?xml version='1.0' encoding='UTF-8'?&gt;
         &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
            &lt;soapenv:Body&gt;
               &lt;m0:uploadFileUsingSwA xmlns:m0=&quot;http://www.apache-synapse.org/test&quot;&gt;
                  &lt;m0:request&gt;
                     &lt;m0:imageId&gt;urn:uuid:15FD2DA2584A32BF7C1177414169826&lt;/m0:imageId&gt;
                  &lt;/m0:request&gt;
               &lt;/m0:uploadFileUsingSwA&gt;
            &lt;/soapenv:Body&gt;
         &lt;/soapenv:Envelope&gt;22--34MIMEBoundaryurn_uuid_B94996494E1DD5F9B511774141704912
17
Content-Type: image/gif
Content-Transfer-Encoding: binary
Content-ID:
         &lt;urn:uuid:15FD2DA2584A32BF7C1177414169826&gt;22800GIF89a... &lt;&lt; binary content &gt;&gt;</div>
                
            </div>
        </div>
        <p><a href="../samples.html">Back to Catalog</a></p>        
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2005-2012
                        <a href="http://www.apache.org/">Apache Software Foundation</a>.
            All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
