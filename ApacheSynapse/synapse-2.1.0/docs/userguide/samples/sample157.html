<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 6, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>
        Apache Synapse - Sample 157</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120106" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Apache Synapse
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-01-06</span>
                  &nbsp;| <span id="projectVersion">Version: 2.1.0</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Main Menu</h5>
                  <ul>
                  <li class="none">
                          <a href="../../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="../../download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../../history.html" title="History">History</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
                          <a href="../../userguide/installation.html" title="Installation Guide">Installation Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/quick_start.html" title="Quick Start Guide">Quick Start Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples/setup/index.html" title="Samples Setup Guide">Samples Setup Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples.html" title="Samples Catalog">Samples Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/config.html" title="Configuration Language">Configuration Language</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/mediators.html" title="Mediators Catalog">Mediators Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/transports.html" title="Transports Catalog">Transports Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/extending.html" title="Extending Synapse">Extending Synapse</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/upgrading.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/deployment.html" title="Deployment">Deployment</a>
            </li>
                  <li class="none">
                          <a href="../../apidocs/" title="Javadocs">Javadocs</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                       <h5>Developer Resources</h5>
                  <ul>
                  <li class="none">
                          <a href="../../dev/developer-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
                  <li class="none">
                          <a href="../../dev/best-practices.html" title="Development Best Practices">Development Best Practices</a>
            </li>
                  <li class="none">
                          <a href="../../dev/release-process.html" title="Release Process">Release Process</a>
            </li>
          </ul>
                       <h5>Project Details</h5>
                  <ul>
                  <li class="none">
                          <a href="../../project-info.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../../mail-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../../source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                  <li class="none">
                          <a href="../../issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                  <li class="none">
                          <a href="../../dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                  <li class="none">
                          <a href="../../team-list.html" title="Project Team">Project Team</a>
            </li>
                  <li class="none">
                          <a href="../../project-summary.html" title="Project Summary">Project Summary</a>
            </li>
          </ul>
                       <h5>Previous Releases</h5>
                  <ul>
                  <li class="none">
                          <a href="../../1_2/docs_index.html" title="Version 1.2">Version 1.2</a>
            </li>
                  <li class="none">
                          <a href="../../1_1_1/content.html" title="Version 1.1.1">Version 1.1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_1/content.html" title="Version 1.1">Version 1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_0/content.html" title="Version 1.0">Version 1.0</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- ~  Licensed to the Apache Software Foundation (ASF) under one
  ~  or more contributor license agreements.  See the NOTICE file
  ~  distributed with this work for additional information
  ~  regarding copyright ownership.  The ASF licenses this file
  ~  to you under the Apache License, Version 2.0 (the
  ~  "License"); you may not use this file except in compliance
  ~  with the License.  You may obtain a copy of the License at
  ~
  ~   http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing,
  ~  software distributed under the License is distributed on an
  ~   * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~  KIND, either express or implied.  See the License for the
  ~  specific language governing permissions and limitations
  ~  under the License. -->
    
        <div class="section"><h2>Sample 157: Conditional Router Mediator for Implementing Complex Routing Scenarios<a name="Sample_157:_Conditional_Router_Mediator_for_Implementing_Complex_Routing_Scenarios"></a></h2>
            <div class="xmlConf">&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;https http&quot; startOnLoad=&quot;true&quot; trace=&quot;disable&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;conditionalRouter continueAfter=&quot;false&quot;&gt;
                    &lt;conditionalRoute breakRoute=&quot;false&quot;&gt;
                        &lt;condition&gt;
                            &lt;match xmlns=&quot;&quot; type=&quot;header&quot; source=&quot;foo&quot; regex=&quot;bar.*&quot;/&gt;
                        &lt;/condition&gt;
                        &lt;target sequence=&quot;cnd1_seq&quot;/&gt;
                    &lt;/conditionalRoute&gt;

                    &lt;conditionalRoute breakRoute=&quot;false&quot;&gt;
                        &lt;condition&gt;
                            &lt;and xmlns=&quot;&quot;&gt;
                                &lt;match type=&quot;header&quot; source=&quot;my_custom_header1&quot; regex=&quot;foo.*&quot;/&gt;
                                &lt;match type=&quot;url&quot; regex=&quot;/services/StockQuoteProxy.*&quot;/&gt;
                            &lt;/and&gt;
                        &lt;/condition&gt;
                        &lt;target sequence=&quot;cnd2_seq&quot;/&gt;
                    &lt;/conditionalRoute&gt;

                    &lt;conditionalRoute breakRoute=&quot;false&quot;&gt;
                        &lt;condition&gt;
                            &lt;and xmlns=&quot;&quot;&gt;
                                &lt;match type=&quot;header&quot; source=&quot;my_custom_header2&quot; regex=&quot;bar.*&quot;/&gt;
                                &lt;equal type=&quot;param&quot; source=&quot;qparam1&quot; value=&quot;qpv_foo&quot;/&gt;
                                &lt;or&gt;
                                    &lt;match type=&quot;url&quot; regex=&quot;/services/StockQuoteProxy.*&quot;/&gt;
                                    &lt;match type=&quot;header&quot; source=&quot;my_custom_header3&quot; regex=&quot;foo.*&quot;/&gt;
                                &lt;/or&gt;
                                &lt;not&gt;
                                    &lt;equal type=&quot;param&quot; source=&quot;qparam2&quot; value=&quot;qpv_bar&quot;/&gt;
                                &lt;/not&gt;
                            &lt;/and&gt;
                        &lt;/condition&gt;
                        &lt;target sequence=&quot;cnd3_seq&quot;/&gt;
                    &lt;/conditionalRoute&gt;
                &lt;/conditionalRouter&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
    &lt;/proxy&gt;

    &lt;sequence name=&quot;cnd1_seq&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;MSG_FLOW&quot; value=&quot;Condition (I) Satisfied&quot;/&gt;
        &lt;/log&gt;
        &lt;sequence key=&quot;send_seq&quot;/&gt;
    &lt;/sequence&gt;
    &lt;sequence name=&quot;cnd2_seq&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;MSG_FLOW&quot; value=&quot;Condition (II) Satisfied&quot;/&gt;
        &lt;/log&gt;
        &lt;sequence key=&quot;send_seq&quot;/&gt;
    &lt;/sequence&gt;
    &lt;sequence name=&quot;cnd3_seq&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;MSG_FLOW&quot; value=&quot;Condition (III) Satisfied&quot;/&gt;
        &lt;/log&gt;
        &lt;sequence key=&quot;send_seq&quot;/&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;send_seq&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;DEBUG&quot; value=&quot;Condition Satisfied&quot;/&gt;
        &lt;/log&gt;
        &lt;send&gt;
            &lt;endpoint name=&quot;simple&quot;&gt;
                &lt;address uri=&quot;http://localhost:9000/services/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;
&lt;/definitions&gt;</div>
            <div class="section"><h3>Objective<a name="Objective"></a></h3>
                <p>
                    Conditional router mediator can be used to implement complex routing rules in
                    Synapse. It can route messages to various endpoints based on URLs, query parameters
                    and transport headers. This sample demonstrates how to use the conditional router
                    mediator within a proxy service to build a smart routing proxy.
                </p>
            </div>
            <div class="section"><h3>Pre-requisites<a name="Pre-requisites"></a></h3>
                <p>
                    </p><ul>
                        <li>
                            Deploy the SimpleStockQuoteService in the sample Axis2 server a d start
                            Axis2 server.
                        </li>
                        <li>
                            Start Synapse using the configuration numbered 157 (repository/conf/sample/synapse_sample_157.xml)
                            <div class="command">
                                Unix/Linux: sh synapse.sh -sample 157<br />
                                Windows: synapse.bat -sample 157
                            </div>
                        </li>
                    </ul>
                
            </div>
            <div class="section"><h3>Executing the Client<a name="Executing_the_Client"></a></h3>
                <p>
                    We will be using 'curl' as the client in this scenario. <a class="externalLink" href="http://curl.haxx.se/">Curl</a>
                    is a neat little command line tool that can be used to generate various types
                    of HTTP requests (among other things).
                </p>
                <p>
                    First create a sample input file named stockQuoteReq.xml with the following
                    content.
                </p>
                <div class="xmlConf">&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot; xmlns:ser=&quot;http://services.samples&quot; xmlns:xsd=&quot;http://services.samples/xsd&quot;&gt;
   &lt;soap:Header/&gt;
   &lt;soap:Body&gt;
      &lt;ser:getQuote&gt;
         &lt;ser:request&gt;
            &lt;xsd:symbol&gt;IBM&lt;/xsd:symbol&gt;
         &lt;/ser:request&gt;
      &lt;/ser:getQuote&gt;
   &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</div>
                <p>
                    Invoke curl as follows to see header based routing feature in action.
                </p>
                <div class="command">curl -d @stockQuoteReq.xml -H &quot;Content-Type: application/soap+xml;charset=UTF-8&quot; -H &quot;foo:bar&quot; &quot;http://localhost:8280/services/StockQuoteProxy&quot;</div>
                <p>
                    This sends a HTTP request with a custom header named 'foo'. Proxy service will
                    detect this header and print a custom log message confirming the receipt of the
                    request.
                </p>
                <p>
                    Now invoke curl as follows to test a combination header and URL based routing.
                </p>
                <div class="command">curl -d @stockQuoteReq.xml -H &quot;Content-Type: application/soap+xml;charset=UTF-8&quot; -H &quot;my_custom_header1:foo1&quot; &quot;http://localhost:8280/services/StockQuoteProxy&quot;</div>
                <p>
                    Finally invoke curl as follows to test routing based on complex conditions.
                </p>
                <div class="command">curl -d @stockQuoteReq.xml -H &quot;Content-Type: application/soap+xml;charset=UTF-8&quot; -H &quot;my_custom_header2:bar&quot; -H &quot;my_custom_header3:foo&quot; &quot;http://localhost:8280/services/StockQuoteProxy?qparam1=qpv_foo&amp;qparam2=qpv_foo2&quot;</div>
                <p>
                    In each case Synapse will log a different log entry because the conditional router
                    mediator uses different sequences to process the three messages.
                </p>
            </div>
        </div>
        <p><a href="../samples.html">Back to Catalog</a></p>
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2005-2012
                        <a href="http://www.apache.org/">Apache Software Foundation</a>.
            All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
