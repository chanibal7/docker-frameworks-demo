<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 6, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>
        Apache Synapse - Sample 55</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120106" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Apache Synapse
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-01-06</span>
                  &nbsp;| <span id="projectVersion">Version: 2.1.0</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Main Menu</h5>
                  <ul>
                  <li class="none">
                          <a href="../../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="../../download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../../history.html" title="History">History</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
                          <a href="../../userguide/installation.html" title="Installation Guide">Installation Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/quick_start.html" title="Quick Start Guide">Quick Start Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples/setup/index.html" title="Samples Setup Guide">Samples Setup Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples.html" title="Samples Catalog">Samples Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/config.html" title="Configuration Language">Configuration Language</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/mediators.html" title="Mediators Catalog">Mediators Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/transports.html" title="Transports Catalog">Transports Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/extending.html" title="Extending Synapse">Extending Synapse</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/upgrading.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/deployment.html" title="Deployment">Deployment</a>
            </li>
                  <li class="none">
                          <a href="../../apidocs/" title="Javadocs">Javadocs</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                       <h5>Developer Resources</h5>
                  <ul>
                  <li class="none">
                          <a href="../../dev/developer-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
                  <li class="none">
                          <a href="../../dev/best-practices.html" title="Development Best Practices">Development Best Practices</a>
            </li>
                  <li class="none">
                          <a href="../../dev/release-process.html" title="Release Process">Release Process</a>
            </li>
          </ul>
                       <h5>Project Details</h5>
                  <ul>
                  <li class="none">
                          <a href="../../project-info.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../../mail-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../../source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                  <li class="none">
                          <a href="../../issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                  <li class="none">
                          <a href="../../dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                  <li class="none">
                          <a href="../../team-list.html" title="Project Team">Project Team</a>
            </li>
                  <li class="none">
                          <a href="../../project-summary.html" title="Project Summary">Project Summary</a>
            </li>
          </ul>
                       <h5>Previous Releases</h5>
                  <ul>
                  <li class="none">
                          <a href="../../1_2/docs_index.html" title="Version 1.2">Version 1.2</a>
            </li>
                  <li class="none">
                          <a href="../../1_1_1/content.html" title="Version 1.1.1">Version 1.1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_1/content.html" title="Version 1.1">Version 1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_0/content.html" title="Version 1.0">Version 1.0</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- ~  Licensed to the Apache Software Foundation (ASF) under one
  ~  or more contributor license agreements.  See the NOTICE file
  ~  distributed with this work for additional information
  ~  regarding copyright ownership.  The ASF licenses this file
  ~  to you under the Apache License, Version 2.0 (the
  ~  "License"); you may not use this file except in compliance
  ~  with the License.  You may obtain a copy of the License at
  ~
  ~   http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing,
  ~  software distributed under the License is distributed on an
  ~   * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~  KIND, either express or implied.  See the License for the
  ~  specific language governing permissions and limitations
  ~  under the License. -->
    
        <div class="section"><h2>Sample 55: Session Affinity Load Balancing Between Fail-over Endpoints<a name="Sample_55:_Session_Affinity_Load_Balancing_Between_Fail-over_Endpoints"></a></h2>
            <div class="xmlConf">&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;errorHandler&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;!-- specify the session as the simple client session provided by Synapse for
                                     testing purpose --&gt;
                    &lt;session type=&quot;simpleClientSession&quot;/&gt;

                    &lt;loadbalance&gt;
                        &lt;endpoint&gt;
                            &lt;failover&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9001/services/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9002/services/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                            &lt;/failover&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;failover&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9003/services/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9004/services/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                            &lt;/failover&gt;
                        &lt;/endpoint&gt;
                    &lt;/loadbalance&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- Send the messages where they have been sent (i.e. implicit To EPR) --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;errorHandler&quot;&gt;
        &lt;makefault response=&quot;true&quot;&gt;
            &lt;code xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot; value=&quot;tns:Receiver&quot;/&gt;
            &lt;reason value=&quot;COULDN'T SEND THE MESSAGE TO THE SERVER.&quot;/&gt;
        &lt;/makefault&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</div>
            <div class="section"><h3>Objective<a name="Objective"></a></h3>
                <p>
                    Demonstrate session aware load balancing in conjunction with fail-over 
                    routing.
                </p>
            </div>
            <div class="section"><h3>Pre-requisites<a name="Pre-requisites"></a></h3>
                <p>
                    </p><ul>
                        <li>
                            Deploy the LoadbalanceFailoverService in the sample Axis2 server (go to
                            samples/axis2Server/src/LoadbalanceFailoverService and run 'ant')
                        </li>
                        <li>
                            Start 4 instances of the Axis2 server on different ports as follows
                            <div class="command">./axis2server.sh -http 9001 -https 9005 -name MyServer1<br />
./axis2server.sh -http 9002 -https 9006 -name MyServer2<br />
./axis2server.sh -http 9003 -https 9007 -name MyServer3<br />
./axis2server.sh -http 9004 -https 9008 -name MyServer4</div>
                        </li>
                        <li>
                            Start Synapse using the configuration numbered 55 (repository/conf/sample/synapse_sample_55.xml)
                            <div class="command">
                                Unix/Linux: sh synapse.sh -sample 55<br />
                                Windows: synapse.bat -sample 55
                            </div>
                        </li>
                    </ul>
                
            </div>
            <div class="section"><h3>Executing the Client<a name="Executing_the_Client"></a></h3>
                <p>
                    This configuration also uses 'simpleClientSession' to bind session ID values to
                    servers as in <a href="sample54.html">sample 54</a>. But fail-over endpoints are
                    specified as the child endpoints of the load balance endpoint. Therefore sessions
                    are bound to the fail-over endpoints. Session information has to be replicated
                    among the servers listed under each failover endpoint using some clustering
                    mechanism. Therefore, if one endpoint bound to a session failed, successive requets
                    for that session will be directed to the next endpoint in that failover group.
                    Run the client using the following command to observe this behaviour.
                </p>
                <div class="command">ant loadbalancefailover -Dmode=session</div>
                <p>
                    You can see a client output as shown below.
                </p>
                <div class="consoleOutput">...
[java] Request: 222 Session number: 0 Response from server: MyServer1
[java] Request: 223 Session number: 0 Response from server: MyServer1
[java] Request: 224 Session number: 1 Response from server: MyServer1
[java] Request: 225 Session number: 2 Response from server: MyServer3
[java] Request: 226 Session number: 0 Response from server: MyServer1
[java] Request: 227 Session number: 1 Response from server: MyServer1
[java] Request: 228 Session number: 2 Response from server: MyServer3
[java] Request: 229 Session number: 1 Response from server: MyServer1
[java] Request: 230 Session number: 1 Response from server: MyServer1
[java] Request: 231 Session number: 2 Response from server: MyServer3
...</div>
                <p>
                    Note that session 0 is always directed to MyServer1 and session 2 is directed to
                    MyServer3. No requests are directed to MyServer2 and MyServer4 as they are kept
                    as backups by fail-over endpoints. Now shutdown the server named MyServer1 while
                    running the sample. You will observe that all successive requests for session 0
                    is now directed to MyServer2, which is the backup server for MyServer1's group.
                    This is shown below, where MyServer1 was shutdown after the request 534.
                </p>
                <div class="consoleOutput">...
[java] Request: 529 Session number: 2 Response from server: MyServer3
[java] Request: 530 Session number: 1 Response from server: MyServer1
[java] Request: 531 Session number: 0 Response from server: MyServer1
[java] Request: 532 Session number: 1 Response from server: MyServer1
[java] Request: 533 Session number: 1 Response from server: MyServer1
[java] Request: 534 Session number: 1 Response from server: MyServer1
[java] Request: 535 Session number: 0 Response from server: MyServer2
[java] Request: 536 Session number: 0 Response from server: MyServer2
[java] Request: 537 Session number: 0 Response from server: MyServer2
[java] Request: 538 Session number: 2 Response from server: MyServer3
[java] Request: 539 Session number: 0 Response from server: MyServer2
...</div>
            </div>
        </div>
        <p><a href="../samples.html">Back to Catalog</a></p>        
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2005-2012
                        <a href="http://www.apache.org/">Apache Software Foundation</a>.
            All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
