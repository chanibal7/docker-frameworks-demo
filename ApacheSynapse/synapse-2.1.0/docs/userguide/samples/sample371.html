<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 6, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>
        Apache Synapse - Sample 371</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120106" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Apache Synapse
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-01-06</span>
                  &nbsp;| <span id="projectVersion">Version: 2.1.0</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Main Menu</h5>
                  <ul>
                  <li class="none">
                          <a href="../../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="../../download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../../history.html" title="History">History</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
                          <a href="../../userguide/installation.html" title="Installation Guide">Installation Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/quick_start.html" title="Quick Start Guide">Quick Start Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples/setup/index.html" title="Samples Setup Guide">Samples Setup Guide</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/samples.html" title="Samples Catalog">Samples Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/config.html" title="Configuration Language">Configuration Language</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/mediators.html" title="Mediators Catalog">Mediators Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/transports.html" title="Transports Catalog">Transports Catalog</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/extending.html" title="Extending Synapse">Extending Synapse</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/upgrading.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/deployment.html" title="Deployment">Deployment</a>
            </li>
                  <li class="none">
                          <a href="../../apidocs/" title="Javadocs">Javadocs</a>
            </li>
                  <li class="none">
                          <a href="../../userguide/faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                       <h5>Developer Resources</h5>
                  <ul>
                  <li class="none">
                          <a href="../../dev/developer-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
                  <li class="none">
                          <a href="../../dev/best-practices.html" title="Development Best Practices">Development Best Practices</a>
            </li>
                  <li class="none">
                          <a href="../../dev/release-process.html" title="Release Process">Release Process</a>
            </li>
          </ul>
                       <h5>Project Details</h5>
                  <ul>
                  <li class="none">
                          <a href="../../project-info.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../../mail-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../../source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                  <li class="none">
                          <a href="../../issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                  <li class="none">
                          <a href="../../dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                  <li class="none">
                          <a href="../../team-list.html" title="Project Team">Project Team</a>
            </li>
                  <li class="none">
                          <a href="../../project-summary.html" title="Project Summary">Project Summary</a>
            </li>
          </ul>
                       <h5>Previous Releases</h5>
                  <ul>
                  <li class="none">
                          <a href="../../1_2/docs_index.html" title="Version 1.2">Version 1.2</a>
            </li>
                  <li class="none">
                          <a href="../../1_1_1/content.html" title="Version 1.1.1">Version 1.1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_1/content.html" title="Version 1.1">Version 1.1</a>
            </li>
                  <li class="none">
                          <a href="../../1_0/content.html" title="Version 1.0">Version 1.0</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- ~  Licensed to the Apache Software Foundation (ASF) under one
  ~  or more contributor license agreements.  See the NOTICE file
  ~  distributed with this work for additional information
  ~  regarding copyright ownership.  The ASF licenses this file
  ~  to you under the Apache License, Version 2.0 (the
  ~  "License"); you may not use this file except in compliance
  ~  with the License.  You may obtain a copy of the License at
  ~
  ~   http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing,
  ~  software distributed under the License is distributed on an
  ~   * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~  KIND, either express or implied.  See the License for the
  ~  specific language governing permissions and limitations
  ~  under the License. -->
    
        <div class="section"><h2>Sample 371: Restricting Requests Based on Policies<a name="Sample_371:_Restricting_Requests_Based_on_Policies"></a></h2>
            <div class="xmlConf">&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;throttle id=&quot;A&quot;&gt;
                &lt;policy&gt;
                    &lt;!-- define throttle policy --&gt;
                    &lt;wsp:Policy xmlns:wsp=&quot;http://schemas.xmlsoap.org/ws/2004/09/policy&quot;
                                xmlns:throttle=&quot;http://www.wso2.org/products/wso2commons/throttle&quot;&gt;
                        &lt;throttle:ThrottleAssertion&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;other&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;4&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;800000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;10000
                                        &lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.200-192.168.8.222
                                &lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;8&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;800000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;10
                                        &lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.201&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;200&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;600000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;/&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.198&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;50&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;500000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;/&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                        &lt;/throttle:ThrottleAssertion&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/policy&gt;
                &lt;onAccept&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Accept**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/services/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/onAccept&gt;
                &lt;onReject&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;makefault response=&quot;true&quot;&gt;
                        &lt;code xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;
                              value=&quot;tns:Receiver&quot;/&gt;
                        &lt;reason value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/makefault&gt;
                    &lt;send/&gt;
                    &lt;drop/&gt;
                &lt;/onReject&gt;
            &lt;/throttle&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;throttle id=&quot;A&quot;/&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</div>
            <div class="section"><h3>Objective<a name="Objective"></a></h3>
                <p>
                    Demonstrate how to throttle incoming requests based on complex policies
                </p>
            </div>
            <div class="section"><h3>Pre-requisites<a name="Pre-requisites"></a></h3>
                <p>
                    </p><ul>
                        <li>
                            Deploy the SimpleStockQuoteService in the sample Axis2 server and start Axis2
                        </li>
                        <li>
                            Start Synapse using the configuration numbered 371 (repository/conf/sample/synapse_sample_371.xml)
                            <div class="command">
                                Unix/Linux: sh synapse.sh -sample 371<br />
                                Windows: synapse.bat -sample 371
                            </div>
                        </li>
                    </ul>
                
            </div>
            <div class="section"><h3>Executing the Client<a name="Executing_the_Client"></a></h3>
                <p>
                    Above configuration specifies a throttle mediator inside the in mediator.
                    Therefore, all request messages directed to the main sequence will be subjected
                    to throttling. Throttle mediator has policy, onAccept and onReject tags at the
                    top level. Policy tag specifies the throttling policy against which all messages
                    will be evaluated. It contains some IP address ranges and the maximum number of
                    messages to be allowed for those ranges within a time period given in 'UnitTime'
                    tag. 'ProhibitTimePeriod' tag specifies the time period to prohibit further
                    requests after the received request count exceeds the specified time. Now run the
                    client 5 times repetitively using the following command to see how throttling works.
                </p>
                <div class="command">ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8280/</div>
                <p>
                    For the first four requests you will get the quote prices for IBM as follows.
                </p>
                <div class="consoleOutput">[java] Standard :: Stock price = $177.20143371883802</div>
                <p>
                    Fifth request will not be sent to the Axis2 server and the client will receive
                    the following fault.
                </p>
                <div class="consoleOutput">[java] org.apache.axis2.AxisFault: **Access Denied**</div>
                <p>
                    Maximum number of requests within 800000 milliseconds is specified as 4 for any
                    server (including localhost) other than the explicitly specified ones. Therefore,
                    our fifth request is denied by the throttle mediator. You can verify this by looking
                    at the Synapse console.
                </p>
                <div class="consoleOutput">[HttpServerWorker-1] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-2] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-3] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-4] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-5] INFO  LogMediator - text = **Access Denied**</div>
            </div>
        </div>
        <p><a href="../samples.html">Back to Catalog</a></p>        
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2005-2012
                        <a href="http://www.apache.org/">Apache Software Foundation</a>.
            All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
