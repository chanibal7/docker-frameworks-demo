<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 6, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>
    
    
      Synapse Samples
    </title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120106" />
    <meta http-equiv="Content-Language" content="en" />
        <meta http-equiv="content-type" content="" /><style type="text/css" xml:space="preserve"></style>
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Apache Synapse
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-01-06</span>
                  &nbsp;| <span id="projectVersion">Version: 2.1.0</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Main Menu</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="../download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../history.html" title="History">History</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
                          <a href="../userguide/installation.html" title="Installation Guide">Installation Guide</a>
            </li>
                  <li class="none">
                          <a href="../userguide/quick_start.html" title="Quick Start Guide">Quick Start Guide</a>
            </li>
                  <li class="none">
                          <a href="../userguide/samples/setup/index.html" title="Samples Setup Guide">Samples Setup Guide</a>
            </li>
                  <li class="none">
                          <a href="../userguide/samples.html" title="Samples Catalog">Samples Catalog</a>
            </li>
                  <li class="none">
                          <a href="../userguide/config.html" title="Configuration Language">Configuration Language</a>
            </li>
                  <li class="none">
                          <a href="../userguide/mediators.html" title="Mediators Catalog">Mediators Catalog</a>
            </li>
                  <li class="none">
                          <a href="../userguide/transports.html" title="Transports Catalog">Transports Catalog</a>
            </li>
                  <li class="none">
                          <a href="../userguide/extending.html" title="Extending Synapse">Extending Synapse</a>
            </li>
                  <li class="none">
                          <a href="../userguide/upgrading.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../userguide/deployment.html" title="Deployment">Deployment</a>
            </li>
                  <li class="none">
                          <a href="../apidocs/" title="Javadocs">Javadocs</a>
            </li>
                  <li class="none">
                          <a href="../userguide/faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                       <h5>Developer Resources</h5>
                  <ul>
                  <li class="none">
                          <a href="../dev/developer-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
                  <li class="none">
                          <a href="../dev/best-practices.html" title="Development Best Practices">Development Best Practices</a>
            </li>
                  <li class="none">
                          <a href="../dev/release-process.html" title="Release Process">Release Process</a>
            </li>
          </ul>
                       <h5>Project Details</h5>
                  <ul>
                  <li class="none">
                          <a href="../project-info.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../mail-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                  <li class="none">
                          <a href="../issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                  <li class="none">
                          <a href="../dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                  <li class="none">
                          <a href="../team-list.html" title="Project Team">Project Team</a>
            </li>
                  <li class="none">
                          <a href="../project-summary.html" title="Project Summary">Project Summary</a>
            </li>
          </ul>
                       <h5>Previous Releases</h5>
                  <ul>
                  <li class="none">
                          <a href="../1_2/docs_index.html" title="Version 1.2">Version 1.2</a>
            </li>
                  <li class="none">
                          <a href="../1_1_1/content.html" title="Version 1.1.1">Version 1.1.1</a>
            </li>
                  <li class="none">
                          <a href="../1_1/content.html" title="Version 1.1">Version 1.1</a>
            </li>
                  <li class="none">
                          <a href="../1_0/content.html" title="Version 1.0">Version 1.0</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <html xmlns="http://www.w3.org/1999/xhtml">
  
    <h1>
      Running the Synapse Samples
    </h1>
    <div class="section"><h2>
      <a name="TOC" id="TOC">Contents</a>
    <a name="Contents"></a></h2>
    <div class="section-content">
      <ul>
        <li>
          <a href="samples_setup.html#Overview">Overview</a>
        </li>
        <li>
          <a href="#MediationSamples">Message mediation samples</a>
          <ul>
            <li>
              <a href="#Sample0">Sample 0: Introduction to Synapse</a>
            </li>
            <li>
              <a href="#Sample1">Sample 1: Simple content based routing (CBR)
              of messages</a>
            </li>
            <li>
              <a href="#Sample2">Sample 2: CBR with the Switch-case mediator,
              using message properties</a>
            </li>
            <li>
              <a href="#Sample3">Sample 3: Local Registry entry definitions,
              reusable endpoints and sequences</a>
            </li>
            <li>
              <a href="#Sample4">Sample 4: Introduction to error handling</a>
            </li>
            <li>
              <a href="#Sample5">Sample 5: Creating SOAP fault messages and
              changing the direction of a message</a>
            </li>
            <li>
              <a href="#Sample6">Sample 6: Manipulating SOAP headers, and
              filtering incoming and outgoing messages</a>
            </li>
            <li>
              <a href="#Sample7">Sample 7: Introduction to local Registry
              entries and using Schema validation</a>
            </li>
            <li>
              <a href="#Sample8">Sample 8: Introduction to static and dynamic
              registry resources, and using XSLT transformations</a>
            </li>
            <li>
              <a href="#Sample9">Sample 9: Introduction to dynamic sequences
              with the Registry</a>
            </li>
            <li>
              <a href="#Sample10">Sample 10: Introduction to dynamic
              endpoints with the Registry</a>
            </li>
            <li>
              <a href="#Sample11">Sample 11: A full registry based
              configuration, and sharing a configuration between multiple
              instances</a>
            </li>
            <li>
              <a href="#Sample12">Sample 12: One way messaging /
              fireAndForget through synapse</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#Endpoints">Advanced mediations with endpoints</a>
          <ul>
            <li>
              <a href="#Sample50">Sample 50: POX to SOAP conversion</a>
            </li>
            <li>
              <a href="#Sample51">Sample 51: MTOM and SwA optimizations and
              request/response correlation</a>
            </li>
            <li>
              <a href="#Sample52">Sample 52: Session less load balancing
              between 3 endpoints</a>
            </li>
            <li>
              <a href="#Sample53">Sample 53: Failover sending among 3
              endpoints</a>
            </li>
            <li>
              <a href="#Sample54">Sample 54: Session affinity load balancing
              between 3 endpoints</a>
            </li>
            <li>
              <a href="#Sample55">Sample 55: Session affinity load balancing
              between fail over endpoints</a>
            </li>
            <li>
              <a href="#Sample56">Sample 56: WSDL endpoint</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#MessageMediationQoS">Quality of Service addition or
          deduction samples in message mediation</a>
          <ul>
            <li>
              <a href="#Sample100">Sample 100: Using WS-Security for outgoing
              messages</a>
            </li>
            <li>
              <a href="#Sample101">Sample 101: Reliable message exchange
              between Synapse and the back-end server using WS-ReliableMessaging</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#ProxyServices">Synapse Proxy service samples</a>
          <ul>
            <li>
              <a href="#Sample150">Sample 150: Introduction to proxy services</a>
            </li>
            <li>
              <a href="#Sample151">Sample 151: Custom sequences and endpoints
              with proxy services</a>
            </li>
            <li>
              <a href="#Sample152">Sample 152: Switching transports and
              message format from SOAP to REST/POX</a>
            </li>
            <li>
              <a href="#Sample153">Sample 153: Routing the messages arrived
              to a proxy service without processing the security headers</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#ProxyServiceQoS">QoS addition and deduction for service
          mediation (proxy) samples</a>
          <ul>
            <li>
              <a href="#Sample200">Sample 200: Using WS-Security with policy
              attachments for proxy services</a>
            </li>
            <li>
              <a href="#Sample201">Sample 201: Reliable message exchange
              between the client and proxy services using WS-ReliableMessaging</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#Transport">Transport samples and switching transports</a>
          <ul>
            <li>
              <a href="#Sample250">Sample 250: Introduction to switching
              transports - JMS to http/s</a>
            </li>
            <li>
              <a href="#Sample251">Sample 251: Switching from http/s to JMS</a>
            </li>
            <li>
              <a href="#Sample252">Sample 252: Pure text/binary and POX
              message support with JMS</a>
            </li>
            <li>
              <a href="#Sample253">Sample 253: One way bridging from JMS to
              http and replying with a 202 Accepted response</a>
            </li>
            <li>
              <a href="#Sample254">Sample 254: Using the file system as
              transport medium using VFS transport listener and sender</a>
            </li>
            <li>
              <a href="#Sample255">Sample 255: Switching from ftp transport
              listener to mail transport sender</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#Task">Introduction to synapse tasks</a>
          <ul>
            <li>
              <a href="#Sample300">Sample 300: Introduction to tasks with
              simple trigger</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#AdvancedMediation">Advanced mediations with advanced
          mediators</a>
          <ul>
            <li>
              <a href="#ScriptMediator">Using scripts in mediation (Script
              Mediator)</a>
              <ul>
                <li>
                  <a href="#Sample350">Sample 350: Introduction to the script
                  mediator using js scripts</a>
                </li>
                <li>
                  <a href="#Sample351">Sample 351: In-line script mediation
                  with JavaScript</a>
                </li>
                <li>
                  <a href="#Sample352">Sample 352: Accessing Synapse message
                  context API methods using scripting language</a>
                </li>
                <li>
                  <a href="#Sample353">Sample 353: Using Ruby scripts for
                  mediation</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#DBMediators">Database interactions in mediation
              (DBLookup / DBReport)</a>
              <ul>
                <li>
                  <a href="#Sample360">Sample 360: Introduction to dblookp
                  mediator</a>
                </li>
                <li>
                  <a href="#Sample361">Sample 361: Introduction to dbreport
                  mediator</a>
                </li>
                <li>
                  <a href="#Sample362">Sample 362: Action of dbreport and
                  dblookup mediators together</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#Throttle">Throtteling messages (Throttle Mediator)</a>
              <ul>
                <li>
                  <a href="#Sample370">Sample 370: Introduction to throttle
                  mediator and concurrency throttling</a>
                </li>
                <li>
                  <a href="#Sample371">Sample 371: Restricting requests based
                  on policies</a>
                </li>
                <li>
                  <a href="#Sample372">Sample 372: Use of both concurrency
                  throttling and request rate based throttling </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#Class">Extending the mediation in java (Class
              Mediator)</a>
              <ul>
                <li>
                  <a href="#Sample380">Sample 380: Writing your own custom
                  mediation in Java</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#XQuery">Evaluating XQuery for mediation (XQuery
              Mediator)</a>
              <ul>
                <li>
                  <a href="#Sample390">Sample 390: Introduction to the XQuery
                  mediator</a>
                </li>
                <li>
                  <a href="#Sample391">Sample 391: How to use the data from
                  an external XML document with in XQuery </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#Splitter">Splitting messages in to parts and process
              in parallel (Iterate / Clone)</a>
              <ul>
                <li>
                  <a href="#Sample400">Sample 400: Message splitting and
                  aggregating the responses</a>
                </li>
              </ul>
            </li>






            <li>
              <a href="#Cache">Caching the responses over the requests</a>
              <ul>
                <li>
                  <a href="#Sample420">Sample 420: Simple cache implemented
                  on synapse for the actual service</a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </div>
    <h1>
      <a name="MediationSamples" id="MediationSamples">Message Mediation
      Samples</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample0" id="Sample0">Sample 0: Introduction to Synapse</a>
    <a name="Sample_0:_Introduction_to_Synapse"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;!-- log all attributes of messages passing through --&gt;
    &lt;log level=&quot;full&quot;/&gt;

    &lt;!-- Send the messageto implicit destination --&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduction to Synapse. Shows how a message could
      be made to pass through Synapse </b><b>and logged
      before it is delivered to its ultimate receiver.</b>
    </p>
    <p>
      The Stock quote client can operate in the following modes for this
      example.
    </p>
    <ol style="list-style-type: decimal">
      <li>
        Smart Client mode
      </li>
      <li>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ </pre></div>
      </li>
      <li>
        Using Synapse as a HTTP Proxy
      </li>
      <li>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dprxurl=http://localhost:8080/</pre></div>
      </li>
      <li>
        Gateway Mode / Dumb Client
      </li>
      <li>
        <p>
          See sample # 1
        </p>
      </li>
    </ol>
    <p>
      <b>Prerequisites:<br /> </b>Start the Synapse
      configuration numbered 0: e.g. synapse -sample 0<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already deployed
    </p>
    <p>
      <b>Execute the Smart Client </b>
    </p>
    <p>
      By tracing the execution of Synapse with the log output level set to
      DEBUG, you will see the client request arriving at Synapse with a
      WS-Addressing 'To' set to EPR
      http://localhost:9000/soap/SimpleStockQuoteService. The Synapse engine
      logs the message at the &quot;full&quot; log level (i.e. all the message headers and
      the body) then sends the message to its implicit 'To' address which is
      http://localhost:9000/soap/SimpleStockQuoteService. You will see a message
      in the Axis2 server console confirming that the message got routed to the
      sample server and the sample service hosted at the sample server
      generating a stock quote for the requested symbol.
    </p>
<div><pre>Sat Nov 18 21:01:23 IST 2006 SimpleStockQuoteService :: Generating quote for : IBM</pre></div>
    <p>
      The response message generated by the service is again received by
      Synapse, and flows through the same mediation rules, which logs the
      response message and then sends it back. This time to the client. On the
      client console you should see an output similar to the following based on
      the message received by the client.
    </p>
<div><pre>Standard :: Stock price = $95.26454380258552</pre></div>
    <p>
      <b>Execute the Proxy Client </b>
    </p>
    <p>
      You will see the exact same behaviour as per the previous example when you
      run this scenario. However this time the difference is at the client, as
      it sends the message to the WS-Addressing 'To' address
      http://localhost:9000/soap/SimpleStockQuoteService, but the transport
      specifies Synapse as the http proxy.
    </p>
    <div class="section"><h2>
      <a name="Sample1" id="Sample1">Sample 1: Simple content based routing
      (CBR) of messages</a>
    <a name="Sample_1:_Simple_content_based_routing______CBR_of_messages"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;!-- filtering of messages with XPath and regex matches --&gt;
    &lt;filter source=&quot;get-property('To')&quot; regex=&quot;.*/StockQuote.*&quot;&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
        &lt;drop/&gt;
    &lt;/filter&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to simple content based routing. Shows
      how a message could be made to pass through Synapse using the Dumb Client
      mode, where Synapse acts as a gateway to accept all messages and then
      perform mediation and routing based on message properties or content.</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 1: i.e. synapse -sample 1<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already deployed<br />
    </p>
    <p>
      Execute the Dumb Client as:
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuote</pre></div>
    <p>
      This time you will see Synapse receiving a message for which Synapse was
      set as the ultimate receiver of the message. Based on the 'To' EPR of
      http://localhost:8080/soap/StockQuote, Synapse performs a match to the
      path '/StockQuote' and as the request matches the XPath expression of the
      filter mediator, the filter mediator's child mediators execute. This sends
      the message to a different endpoint as specified by the endpoint
      definition. The 'drop' mediator terminates further processing of the
      current message in a configuration. During response processing, the filter
      condition fails, and thus the implicit 'send' mediator forwards the
      response back to the client.
    </p>
    <div class="section"><h2>
      <a name="Sample2" id="Sample2">Sample 2: CBR with the Switch-case
      mediator, using message properties</a>
    <a name="Sample_2:_CBR_with_the_Switch-case______mediator_using_message_properties"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;switch source=&quot;//m0:getQuote/m0:request/m0:symbol&quot; xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
        &lt;case regex=&quot;IBM&quot;&gt;
            &lt;!-- the property mediator sets a local property on the *current* message --&gt;
            &lt;property name=&quot;symbol&quot; value=&quot;Great stock - IBM&quot;/&gt;
        &lt;/case&gt;
        &lt;case regex=&quot;MSFT&quot;&gt;
            &lt;property name=&quot;symbol&quot; value=&quot;Are you sure? - MSFT&quot;/&gt;
        &lt;/case&gt;
        &lt;default&gt;
            &lt;!-- it is possible to assign the result of an XPath expression as well --&gt;
            &lt;property name=&quot;symbol&quot;
                  expression=&quot;fn:concat('Normal Stock - ', //m0:getQuote/m0:request/m0:symbol)&quot;
                  xmlns:m0=&quot;http://services.samples/xsd&quot;/&gt;
        &lt;/default&gt;
    &lt;/switch&gt;

    &lt;log level=&quot;custom&quot;&gt;
        &lt;!-- the get-property() XPath extension function allows the lookup of local message properties
            as well as properties from the Axis2 or Transport contexts (i.e. transport headers) --&gt;
        &lt;property name=&quot;symbol&quot; expression=&quot;get-property('symbol')&quot;/&gt;
        &lt;!-- the get-property() function supports the implicit message headers To/From/Action/FaultTo/ReplyTo --&gt;
        &lt;property name=&quot;epr&quot; expression=&quot;get-property('To')&quot;/&gt;
    &lt;/log&gt;

    &lt;!-- Send the messages where they are destined to (i.e. the 'To' EPR of the message) --&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduce switch-case mediator and writing and
      reading of local properties set on a message instance</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 2: i.e. synapse -sample 2<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done.
    </p>
    <p>
      Execute the 'ant stockquote ..' request again in the smart client mode,
      specifying 'IBM', 'MSFT' and 'SUN' as the stock symbols. When the symbol
      IBM is requested, viewing the mediation logs you will see that the case
      statements' first case for 'IBM' is executed and a local property named
      'symbol' was set to 'Great stock - IBM'. Subsequently this local property
      value is looked up by the log mediator and logged using the
      'get-property()' XPath extension function.
    </p>
    <p>
      ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService
      -Dtrpurl=http://localhost:8080/ -Dsymbol=IBM
    </p>
<div><pre>INFO LogMediator - symbol = Great stock - IBM, epr = http://localhost:9000/axis2/services/SimpleStockQuoteService </pre></div>
    <p>
      ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService
      -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT
    </p>
<div><pre>INFO LogMediator - symbol = Are you sure? - MSFT, epr = http://localhost:9000/axis2/services/SimpleStockQuoteService</pre></div>
    <div class="section"><h2>
      <a name="Sample3" id="Sample3">Sample 3: Local Registry entry
      definitions, reusable endpoints and sequences</a>
    <a name="Sample_3:_Local_Registry_entry______definitions_reusable_endpoints_and_sequences"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;!-- define a string resource entry to the local registry --&gt;
    &lt;localEntry key=&quot;version&quot;&gt;0.1&lt;/localEntry&gt;
    &lt;!-- define a reuseable endpoint definition --&gt;
    &lt;endpoint name=&quot;simple&quot;&gt;
        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
    &lt;/endpoint&gt;

    &lt;!-- define a reusable sequence --&gt;
    &lt;sequence name=&quot;stockquote&quot;&gt;
        &lt;!-- log the message using the custom log level. illustrates custom properties for log --&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;Text&quot; value=&quot;Sending quote request&quot;/&gt;
            &lt;property name=&quot;version&quot; expression=&quot;get-property('version')&quot;/&gt;
            &lt;property name=&quot;direction&quot; expression=&quot;get-property('direction')&quot;/&gt;
        &lt;/log&gt;
        &lt;!-- send message to real endpoint referenced by key &quot;simple&quot; endpoint definition --&gt;
        &lt;send&gt;
            &lt;endpoint key=&quot;simple&quot;/&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;property name=&quot;direction&quot; value=&quot;incoming&quot;/&gt;
            &lt;sequence key=&quot;stockquote&quot;/&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Illustrates local registry entry definitions,
      reusable endpoints and sequences</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 3: i.e. synapse -sample 3<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      This example uses a sequence named as &quot;main&quot; that specifies the main
      mediation rules to be executed. This is equivalent to directly specifying
      the mediators of the main sequence within the &lt;definitions&gt; tags.
      This is the recommended and also a better approach for non-trivial
      configurations. Execute the 'ant stockquote ..' request again, and
      following through the mediation logs you will now notice that the sequence
      named &quot;main&quot; is executed. Then for the incoming message flow the &lt;in&gt;
      mediator executes, and it calls into the sequence named &quot;stockquote&quot;.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/</pre></div>
<div><pre>DEBUG SequenceMediator - Sequence mediator &lt;main&gt; :: mediate()DEBUG InMediator - In mediator mediate()DEBUG SequenceMediator - Sequence mediator &lt;stockquote&gt; :: mediate()</pre></div>
    <p>
      As the &quot;stockquote&quot; sequence executes, the log mediator dumps a simple
      text/string property, result of an XPath evaluation, that picks up the key
      named &quot;version&quot;, and a second result of an XPath evaluation that picks up
      a local message property set previously by the &lt;property&gt; mediator.
      The get-property() XPath extension function is able to read message
      properties local to the current message, local or remote registry entries,
      Axis2 message context properties as well as transport headers. The local
      entry definition for &quot;version&quot; defines a simple text/string registry entry
      for that which is visible to all messages that pass through Synapse.
    </p>
<div><pre>[HttpServerWorker-1] INFO  LogMediator - Text = Sending quote request, version = 0.1, direction = incoming
[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate()
[HttpServerWorker-1] DEBUG AddressEndpoint - Sending To: http://localhost:9000/soap/SimpleStockQuoteService </pre></div>
    <div class="section"><h2>
      <a name="Sample4" id="Sample4">Sample 4: Introduction to error handling</a>
    <a name="Sample_4:_Introduction_to_error_handling"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;!-- the default fault handling sequence used by Synapse - named 'fault' --&gt;
    &lt;sequence name=&quot;fault&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;text&quot; value=&quot;An unexpected error occured&quot;/&gt;
            &lt;property name=&quot;message&quot; expression=&quot;get-property('ERROR_MESSAGE')&quot;/&gt;
        &lt;/log&gt;
        &lt;drop/&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;sunErrorHandler&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;text&quot; value=&quot;An unexpected error occured for stock SUN&quot;/&gt;
            &lt;property name=&quot;message&quot; expression=&quot;get-property('ERROR_MESSAGE')&quot;/&gt;
        &lt;/log&gt;
        &lt;drop/&gt;
    &lt;/sequence&gt;

    &lt;!-- default message handling sequence used by Synapse - named 'main' --&gt;
    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;switch source=&quot;//m0:getQuote/m0:request/m0:symbol&quot; xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                &lt;case regex=&quot;IBM&quot;&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;&lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;&lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex=&quot;MSFT&quot;&gt;
                    &lt;send&gt;
                        &lt;endpoint key=&quot;bogus&quot;/&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex=&quot;SUN&quot;&gt;
                    &lt;sequence key=&quot;sunSequence&quot;/&gt;
                &lt;/case&gt;
            &lt;/switch&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;sequence name=&quot;sunSequence&quot; onError=&quot;sunErrorHandler&quot;&gt;
        &lt;send&gt;
            &lt;endpoint key=&quot;sunPort&quot;/&gt;
        &lt;/send&gt;
&lt;/sequence&gt;

&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to error handling with the 'fault'
      sequence</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 4: i.e. synapse -sample 4<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      When the IBM stock quote is requested, the configuration routes it to the
      defined inline endpoint, which routes the message to the
      SimpleStockQuoteService on the local Axis2 instance. Hence a valid
      response message is shown at the client.
    </p>
    <p>
      If you lookup a stock quote for 'MSFT', Synapse is instructed to route the
      message to the endpoint defined as the 'bogus' endpoint, which does not
      exist. Synapse executes the specified error handler sequence closest to
      the point where the error was encountered. In this case, the currently
      executing sequence is 'main' and it does not specify an 'onError'
      attribute. Whenever Synapse cannot find an error handler, it looks for a
      sequence named 'fault'. Thus the 'fault' sequence can be seen executing,
      and writing the generic error message to the logs.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</pre></div>
<div><pre>[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate()
[HttpServerWorker-1] ERROR IndirectEndpoint - Reference to non-existent endpoint for key : bogus
[HttpServerWorker-1] DEBUG MediatorFaultHandler - MediatorFaultHandler :: handleFault
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;fault&gt; :: mediate()
[HttpServerWorker-1] DEBUG LogMediator - Log mediator :: mediate()
[HttpServerWorker-1] INFO  LogMediator - text = An unexpected error occured, message = Reference to non-existent endpoint for key : bogus</pre></div>
    <p>
      When the 'SUN' quote is requested, a custom sequence 'sunSequence' is
      invoked, and it specifies 'sunErrorHandler' as its error handler. Hence
      when the send fails, you could see the proper error handler invocation and
      the custom error message printed as follows.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=SUN</pre></div>
<div><pre>[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;sunSequence&gt; :: mediate()
[HttpServerWorker-1] DEBUG SequenceMediator - Setting the onError handler for the sequence
[HttpServerWorker-1] DEBUG AbstractListMediator - Implicit Sequence &lt;SequenceMediator&gt; :: mediate()
[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate()
[HttpServerWorker-1] ERROR IndirectEndpoint - Reference to non-existent endpoint for key : sunPort
[HttpServerWorker-1] DEBUG MediatorFaultHandler - MediatorFaultHandler :: handleFault
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;sunErrorHandler&gt; :: mediate()
[HttpServerWorker-1] DEBUG AbstractListMediator - Implicit Sequence &lt;SequenceMediator&gt; :: mediate()
[HttpServerWorker-1] DEBUG LogMediator - Log mediator :: mediate()
[HttpServerWorker-1] INFO  LogMediator - text = An unexpected error occured for stock SUN, message = Reference to non-existent endpoint for key : sunPort</pre></div>
    <div class="section"><h2>
      <a name="Sample5" id="Sample5">Sample 5: Creating SOAP fault messages
      and changing the direction of a message</a>
    <a name="Sample_5:_Creating_SOAP_fault_messages______and_changing_the_direction_of_a_message"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;myFaultHandler&quot;&gt;
        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason expression=&quot;get-property('ERROR_MESSAGE')&quot;/&gt;
        &lt;/makefault&gt;

        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
        &lt;header name=&quot;To&quot; expression=&quot;get-property('ReplyTo')&quot;/&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;myFaultHandler&quot;&gt;
        &lt;in&gt;
            &lt;switch source=&quot;//m0:getQuote/m0:request/m0:symbol&quot;
                    xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                &lt;case regex=&quot;MSFT&quot;&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;&lt;address uri=&quot;http://bogus:9000/soap/NonExistentStockQuoteService&quot;/&gt;&lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex=&quot;SUN&quot;&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;&lt;address uri=&quot;http://localhost:9009/soap/NonExistentStockQuoteService&quot;/&gt;&lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
            &lt;/switch&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Makefault mediator and sending back error responses
      </b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 5: i.e. synapse -sample 5<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      When the MSFT stock quote is requested, an unknown host exception would be
      generated. A connection refused exception would be generated for the SUN
      stock request. This error message is captured and returned to the original
      client as a SOAP fault in this example.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</pre></div>
    <p>
      returns,
    </p>
<div><pre>&lt;soapenv:Fault xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;faultcode&gt;soapenv:Client&lt;/faultcode&gt;
    &lt;faultstring&gt;java.net.UnknownHostException: bogus&lt;/faultstring&gt;&lt;detail /&gt;&lt;/soapenv:Fault&gt;</pre></div>
    <p>
      And
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=SUN</pre></div>
    <p>
      returns,
    </p>
<div><pre>&lt;soapenv:Fault xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;faultcode&gt;soapenv:Client&lt;/faultcode&gt;
    &lt;faultstring&gt;java.net.ConnectException: Connection refused&lt;/faultstring&gt;&lt;detail /&gt;&lt;/soapenv:Fault&gt;</pre></div>
    <div class="section"><h2>
      <a name="Sample6" id="Sample6">Sample 6: Manipulating SOAP headers, and
      filtering incoming and outgoing messages</a>
    <a name="Sample_6:_Manipulating_SOAP_headers_and______filtering_incoming_and_outgoing_messages"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;in&gt;
        &lt;header name=&quot;To&quot; value=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
    &lt;/in&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduction to header, in (out) mediators</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 6: i.e. synapse -sample 6<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      In this example we use the stockquote client in the dumb client mode,
      setting the 'To' EPR of the message to Synapse. Then the 'in' mediator
      processes the incoming messages, and manipulates the 'To' header to refer
      to the stock quote service on the sample Axis2 server. Thus it is now
      possible to request for a stock quote as follows.
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/</pre></div>
    <div class="section"><h2>
      <a name="Sample7" id="Sample7">Sample 7: Introduction to local Registry
      entries and using Schema validation</a>
    <a name="Sample_7:_Introduction_to_local_Registry______entries_and_using_Schema_validation"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;localEntry key=&quot;validate_schema&quot;&gt;
        &lt;xs:schema xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot;
                    xmlns=&quot;http://www.apache-synapse.org/test&quot; elementFormDefault=&quot;qualified&quot;
                    attributeFormDefault=&quot;unqualified&quot;
                    targetNamespace=&quot;http://services.samples/xsd&quot;&gt;
            &lt;xs:element name=&quot;getQuote&quot;&gt;
                &lt;xs:complexType&gt;
                    &lt;xs:sequence&gt;
                        &lt;xs:element name=&quot;request&quot;&gt;
                            &lt;xs:complexType&gt;
                                &lt;xs:sequence&gt;
                                    &lt;xs:element name=&quot;stocksymbol&quot; type=&quot;xs:string&quot;/&gt;
                                &lt;/xs:sequence&gt;
                            &lt;/xs:complexType&gt;
                        &lt;/xs:element&gt;
                    &lt;/xs:sequence&gt;
                &lt;/xs:complexType&gt;
            &lt;/xs:element&gt;
        &lt;/xs:schema&gt;
    &lt;/localEntry&gt;

    &lt;in&gt;
        &lt;validate&gt;
            &lt;schema key=&quot;validate_schema&quot;/&gt;
            &lt;on-fail&gt;
                &lt;!-- if the request does not validate againt schema throw a fault --&gt;
                &lt;makefault&gt;
                    &lt;code value=&quot;tns:Receiver&quot;
                            xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
                    &lt;reason value=&quot;Invalid custom quote request&quot;/&gt;
                &lt;/makefault&gt;
                &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
                &lt;header name=&quot;To&quot; expression=&quot;get-property('ReplyTo')&quot;/&gt;
            &lt;/on-fail&gt;
        &lt;/validate&gt;
    &lt;/in&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to local (static) registry entries and
      the validate mediator</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 7: i.e. synapse -sample 7<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      This example shows how a static XML fragment could be made available to
      the Synapse local registry. Resources defined in the local registry are
      static (i.e. never changes over the lifetime of the configuration) and may
      be specified as a source URL, inline text or inline xml. In this example
      the schema is made available under the key 'validate_schema'.
    </p>
    <p>
      The validate mediator by default operates on the first child element of
      the SOAP body. You may specify an XPath expression using the 'source'
      attribute to override this behaviour. The validate mediator now uses the
      'validate_schema' resource to validate the incoming message, and if the
      message validatation fails it invokes the 'on-fail' sequence of mediators.
    </p>
    <p>
      If you send a stockquote request using 'ant stockquote ...' you will get a
      fault back with the message 'Invalid custom quote request' as the schema
      validation failed. This is because the schema used in the example expects
      a slightly different message than what is created by the stock quote
      client. (i.e. expects a 'stocksymbol' element instead of 'symbol' to
      specify thestock symbol)
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/</pre></div>
    <div class="section"><h2>
      <a name="Sample8" id="Sample8">Sample 8: Introduction to static and
      dynamic registry resources, and using XSLT transformations</a>
    <a name="Sample_8:_Introduction_to_static_and______dynamic_registry_resources_and_using_XSLT_transformations"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;!-- the SimpleURLRegistry allows access to a URL based registry (e.g. file:/// or http://) --&gt;
    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:./repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;!-- define the request processing XSLT resource as a static URL source --&gt;
    &lt;localEntry key=&quot;xslt-key-req&quot; src=&quot;file:repository/conf/sample/resources/transform/transform.xslt&quot;/&gt;

    &lt;in&gt;
        &lt;!-- transform the custom quote request into a standard quote requst expected by the service --&gt;
        &lt;xslt key=&quot;xslt-key-req&quot;/&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;!-- transform the standard response back into the custom format the client expects --&gt;
        &lt;!-- the key is looked up in the remote registry and loaded as a 'dynamic' registry resource --&gt;
        &lt;xslt key=&quot;transform/transform_back.xslt&quot;/&gt;
    &lt;/out&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduction to static and dynamic registry
      resources and the XSLT mediator</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 8: i.e. synapse -sample 8<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      This example uses the XSLT mediator to perform transformations, and the
      xslt tranformations are specified as registry resources. The first
      resource 'xslt-key-req' is specified as a 'local' registry entry. Local
      entries do not place the resource on the registry, but simply make it
      available to the local configuration. If a local entry is defined with a
      key that already exists in the remote registry, the local entry will have
      higher preference and override the remote resource.
    </p>
    <p>
      In this example you will notice the new 'registry' definition. Synapse
      comes with a simple URL based registry implementation SimpleURLRegistry.
      During initialization of the registry, the SimpleURLRegistry expects to
      find a property named 'root', which specifies a prefix for the registry
      keys used later. When the SimpleURLRegistry is used, this root is prefixed
      to the entry keys to form the complete URL for the resource being looked
      up. The registry caches a resource once requested, and caches it
      internally for a specified duration. Once this period expires, it will
      reload the meta information about the resource and reload its cached copy
      if necessary, the next time the resource is requested.
    </p>
    <p>
      Hence the second XSLT resource key 'transform/transform_back.xslt'
      concatenated with the 'root' of the SimpleURLRegistry
      'file:repository/conf/sample/resources/' forms the complete URL of the
      resource as
      'file:repository/conf/sample/resources/transform/transform_back.xslt' and
      caches its value for a period of 15000 ms.
    </p>
    <p>
      Execute the custom quote client as 'ant stockquote -Dmode=customquote ...'
      and analyze the the Synapse debug log output
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dmode=customquote</pre></div>
    <p>
      The incoming message is now transformed into a standard stock quote
      request as expected by the SimpleStockQuoteService deployed on the local
      Axis2 instance, by the XSLT mediator. The XSLT mediator uses Xalan-J to
      perform the transformations. It is possible to configure the underlying
      transformation engine using properties where necessary. The response from
      the SimpleStockQuoteService is converted back into the custom format as
      expected by the client during the out message processing.
    </p>
    <p>
      During the response processing you could see the SimpleURLRegistry
      fetching the resource as shown by the log message below
    </p>
<div><pre>[HttpClientWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : transform/transform_back.xslt</pre></div>
    <p>
      If you run the client again immediately (i.e within 15 seconds of the
      first request) you will not see the resource being reloaded by the
      registry as the cached value would be still valid.
    </p>
    <p>
      However if you leave the system idle for 15 seconds or more and then retry
      the same request, you will now notice that the registry noticed the cached
      resource has expired and will check the meta information about the
      resource to check if the resource itself has changed and will require a
      fresh fetch from the source URL. If the meta data / version number
      indicates that a reload of the cached resource is not necessary (i.e.
      unless the resource itself actually changed) the updated meta information
      is used and the cache lease extended as appropriate.
    </p>
<div><pre>[HttpClientWorker-1] DEBUG AbstractRegistry - Cached object has expired for key : transform/transform_back.xslt
[HttpClientWorker-1] DEBUG SimpleURLRegistry - Perform RegistryEntry lookup for key : transform/transform_back.xslt
[HttpClientWorker-1] DEBUG AbstractRegistry - Expired version number is same as current version in registry
[HttpClientWorker-1] DEBUG AbstractRegistry - Renew cache lease for another 15s </pre></div>
    <p>
      Now edit the
      repository/conf/sample/resources/transform/transform_back.xslt file and
      add a blank line at the end. Now when you run the client again, and if the
      cache is expired, the resource would be re-fetched from its URL by the
      registry and this can be seen by the following debug log messages
    </p>
<div><pre>[HttpClientWorker-1] DEBUG AbstractRegistry - Cached object has expired for key : transform/transform_back.xslt
[HttpClientWorker-1] DEBUG SimpleURLRegistry - Perform RegistryEntry lookup for key : transform/transform_back.xslt
[HttpClientWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : transform/transform_back.xslt </pre></div>
    <p>
      Thus the SimpleURLRegistry allows resource to be cached, and updates
      detected so that the changes could be reloaded without restarting the
      Synapse instance.
    </p>
    <div class="section"><h2>
      <a name="Sample9" id="Sample9">Sample 9: Introduction to dynamic
      sequences with the Registry</a>
    <a name="Sample_9:_Introduction_to_dynamic______sequences_with_the_Registry"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:./repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;sequence key=&quot;sequence/dynamic_seq_1.xml&quot;/&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to dynamic sequences with a Registry</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 9: i.e. synapse -sample 9<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      This example introduces the dynamic behaviour of Synapse through the use
      of a Registry. Synapse supports dynamic definitions for sequences and
      endpoints, and as seen before, for resources. In this example we define a
      Synapse configuration which references a sequence definition specified as
      a registry key. The registry key resolves to the actual content of the
      sequence which would be loaded dynamically by Synapse at runtime, and
      cached appropriately as per its definition in the registry. Once the cache
      expires, Synapse would recheck the meta information for the definition and
      re-load the sequence definition if necessary and re-cache it again.
    </p>
    <p>
      Once Synapse is started, execute the stock quote client as 'ant
      stockquote..'. You will notice that that Synapse fetches the definition of
      the sequence from the registry and executes its rules as follows:
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/</pre></div>
<div><pre>[HttpServerWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : sequence/dynamic_seq_1.xml
...
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;dynamic_sequence&gt; :: mediate()
...
[HttpServerWorker-1] INFO  LogMediator - message = *** Test Message 1 ***</pre></div>
    <p>
      Now if you execute the client immediately (i.e. within 15 seconds of the
      last execution) you will notice that the sequence was not reloaded. If you
      edit the sequence definition in
      repository/conf/sample/resources/sequence/dynamic_seq_1.xml (i.e. edit the
      log message to read as &quot;*** Test Message 2 ***&quot;) and execute the client
      again, you will notice that the new message is not yet visible (i.e. if
      you execute this within 15 seconds of loading the resource for the first
      time) However, after 15 seconds elapsed since the original caching of the
      sequence, you will notice that the new sequence is loaded and executed by
      Synapse from the following log messages.
    </p>
<div><pre>[HttpServerWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : sequence/dynamic_seq_1.xml
...
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;dynamic_sequence&gt; :: mediate()
...
[HttpServerWorker-1] INFO  LogMediator - message = *** Test Message 2 ***</pre></div>
    <p>
      The cache timeout could be tuned appropriately by configuring the URL
      registry to suite the environment and the needs.
    </p>
    <div class="section"><h2>
      <a name="Sample10" id="Sample10">Sample 10: Introduction to dynamic
      endpoints with the Registry</a>
    <a name="Sample_10:_Introduction_to_dynamic______endpoints_with_the_Registry"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;in&gt;
        &lt;send&gt;
            &lt;endpoint key=&quot;endpoint/dynamic_endpt_1.xml&quot;/&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to dynamic endpoints with the Registry</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 10: i.e. synapse -sample 10<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done<br />
      Start a second Axis2 server on http port 9001 and https port 9003 as
      follows:
    </p>
<div><pre>./axis2server.sh -http 9001 -https 9003</pre></div>
    <p>
      This example introduces dynamic endpoints, where the definition of an
      endpoint is stored in the Registry. To follow this example execute the
      stock quote client as 'ant stockquote..' and see that the message is
      routed to the SimpleStockQuoteService on the default Axis2 instance on
      http port 9000. Repeat the above example immediately again, and notice
      that the endpoint is cached and reused by Synapse - similarly to example #
      8.
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/</pre></div>
    <p>
      Now edit the repository/conf/sample/resources/endpoint/dynamic_endpt_1.xml
      definition and update the address to
      &quot;http://localhost:9001/soap/SimpleStockQuoteService&quot;. After the cached
      expires, the Registry loads the new definition of the endpoint, and then
      the messages can be seen being routed to the second sample Axis2 server on
      http port 9001.
    </p>
    <div class="section"><h2>
      <a name="Sample11" id="Sample11">Sample 11: A full registry based
      configuration, and sharing a configuration between multiple instances</a>
    <a name="Sample_11:_A_full_registry_based______configuration_and_sharing_a_configuration_between_multiple_instances"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:./repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: A full registry based configuration</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 11: i.e. synapse -sample 11<br /> Start the Axis2
      server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      This example shows a full registry based Synapse configuration. Thus it is
      possible to start a remote configuration from multiple instances of
      Synapse in a clustered environment easily. The Synapse configuration held
      on a node hosting Synapse simply points to the registry and looks up the
      actual configuration by requesting the key 'synapse.xml'.
    </p>
    <p>
      (Note: Full registry based configuration is not dynamic atleast for the
      moment. i.e. it is not reloading itself)
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/</pre></div>
<div><pre>[HttpServerWorker-1] INFO LogMediator - message = This is a dynamic Synapse configuration</pre></div>
    <p>
      The actual synapse.xml loaded is:
    </p>
<div><pre>&lt;!-- a registry based Synapse configuration --&gt;
&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;log level=&quot;custom&quot;&gt;
        &lt;property name=&quot;message&quot; value=&quot;This is a dynamic Synapse configuration $$$&quot;/&gt;
    &lt;/log&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre></div>
    <div class="section"><h2>
      <a name="Sample12" id="Sample12">Sample 12: One way messaging /
      fireAndForget through synapse</a>
    <a name="Sample_12:_One_way_messaging_______fireAndForget_through_synapse"></a></h2>
    <p>
      <b>Objective: Demonstrate one way messaging / fireAndForget
      through synapse</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Axis2 server
      and deploy the SimpleStockQuoteService (Refer steps above)<br /> Start
      the Synapse configuration numbered 1: i.e. synapse -sample 1
    </p>
    <p>
      This example invokes the one-way 'placeOrder' operation on the
      SimpleStockQuoteService using the custom client which uses the Axis2
      ServiceClient.fireAndForget() API. To test this, use 'ant
      -Dmode=placeorder...' and you will notice the one way message flowing
      through Synapse into the sample Axis2 server instance, which reports the
      acceptance of the order as follows:
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dmode=placeorder</pre></div>
<div><pre>SimpleStockQuoteService :: Accepted order for : 7482 stocks of IBM at $ 169.27205579038733</pre></div>
    <p>
      If you send your client request through TCPmon, you will notice that the
      SimpleStockQuoteService replies to Synapse with a HTTP 202 reply, and that
      Synapse in-turn replies to the client with a HTTP 202 acknowledgement
    </p>
    <h1>
      <a name="Endpoints" id="Endpoints">Advanced mediations with endpoints</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample50" id="Sample50">Sample 50: POX to SOAP conversion</a>
    <a name="Sample_50:_POX_to_SOAP_conversion"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;!-- filtering of messages with XPath and regex matches --&gt;
    &lt;filter source=&quot;get-property('To')&quot; regex=&quot;.*/StockQuote.*&quot;&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot; format=&quot;soap11&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
        &lt;drop/&gt;
    &lt;/filter&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: POX to SOAP conversion</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 50: i.e. synapse -sample 50
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p>
      Execute the 'ant stockquote' specifying that the request should be a REST
      request as follows:
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuote -Drest=true</pre></div>
    <p>
      This example shows a http REST request (as shown below) being transformed
      into a SOAP request and forwarded to the stock quote service.
    </p>
<div><pre>POST /soap/StockQuote HTTP/1.1
Content-Type: application/xml; charset=UTF-8;action=&quot;urn:getQuote&quot;;
SOAPAction: urn:getQuote
User-Agent: Axis2
Host: 127.0.0.1
Transfer-Encoding: chunked

75
&lt;m0:getQuote xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
   &lt;m0:request&gt;
      &lt;m0:symbol&gt;IBM&lt;/m0:symbol&gt;
   &lt;/m0:request&gt;
&lt;/m0:getQuote&gt;0</pre></div>
    <div class="section"><h2>
      <a name="Sample51" id="Sample51">Sample 51: MTOM and SwA optimizations
      and request/response correlation</a>
    <a name="Sample_51:_MTOM_and_SwA_optimizations______and_requestresponse_correlation"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;in&gt;
        &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingMTOM&quot;&gt;
            &lt;property name=&quot;example&quot; value=&quot;mtom&quot;/&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;address uri=&quot;http://localhost:9000/soap/MTOMSwASampleService&quot; optimize=&quot;mtom&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/filter&gt;
        &lt;filter source=&quot;get-property('Action')&quot; regex=&quot;urn:uploadFileUsingSwA&quot;&gt;
            &lt;property name=&quot;example&quot; value=&quot;swa&quot;/&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;address uri=&quot;http://localhost:9000/soap/MTOMSwASampleService&quot; optimize=&quot;swa&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/filter&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;filter source=&quot;get-property('example')&quot; regex=&quot;mtom&quot;&gt;
            &lt;property name=&quot;enableMTOM&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;
        &lt;/filter&gt;
        &lt;filter source=&quot;get-property('example')&quot; regex=&quot;swa&quot;&gt;
            &lt;property name=&quot;enableSwA&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;
        &lt;/filter&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: MTOM and SwA optimizations and request/response
      correlation</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 51: i.e. synapse -sample 51<br /> Start the Axis2
      server and deploy the MTOMSwASampleService if not already done
    </p>
    <p>
      Execute the 'ant optimizeclient' specifying MTOM optimization as follows:
    </p>
<div><pre>ant optimizeclient -Dopt_mode=mtom</pre></div>
    <p>
      The configuration now sets a local message context property, and forwards
      the message to 'http://localhost:9000/soap/MTOMSwASampleService'
      optimizing binary content as MTOM. By sending this message through TCPMon
      you would be able to see the actual message sent over the http transport
      if required. Thus during response processing, by checking the local
      message property Synapse could identify the past information about the
      current message context, and uses this knowledge to transform the response
      back to the client in the same format as the original request.
    </p>
    <p>
      When the client executes successfully, it will upload a file containing
      the ASF logo and receive its response back again and save it into a
      temporary file.
    </p>
<div><pre>[java] Sending file : ./../../repository/conf/sample/resources/mtom/asf-logo.gif as MTOM</pre></div>
<div><pre>[java] Saved response to file : /tmp/mtom-36877.gif</pre></div>
    <p>
      Next try SwA as:
    </p>
<div><pre>ant optimizeclient -Dopt_mode=swa</pre></div>
<div><pre>[java] Sending file : ./../../repository/conf/sample/resources/mtom/asf-logo.gif as SwA
[java] Saved response to file : /tmp/swa-47549.gif</pre></div>
    <p>
      By using TCPMon and sending the message through it, one can inspect that
      the requests and responses sent are indeed MTOM optimized or sent as http
      attachments as follows:
    </p>
<div><pre>POST http://localhost:9000/soap/MTOMSwASampleService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:uploadFileUsingMTOM
Content-Type: multipart/related; boundary=MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353; type=&quot;application/xop+xml&quot;;
start=&quot;&lt;0.urn:uuid:B94996494E1DD5F9B51177413845354@apache.org&gt;&quot;; start-info=&quot;text/xml&quot;; charset=UTF-8
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353241
Content-Type: application/xop+xml; charset=UTF-8; type=&quot;text/xml&quot;
Content-Transfer-Encoding: binary
Content-ID:
   &lt;0.urn:uuid:B94996494E1DD5F9B51177413845354@apache.org&gt;221b1
      &lt;?xml version='1.0' encoding='UTF-8'?&gt;
         &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
            &lt;soapenv:Body&gt;
               &lt;m0:uploadFileUsingMTOM xmlns:m0=&quot;http://www.apache-synapse.org/test&quot;&gt;
                  &lt;m0:request&gt;
                     &lt;m0:image&gt;
                        &lt;xop:Include href=&quot;cid:1.urn:uuid:78F94BC50B68D76FB41177413845003@apache.org&quot; xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; /&gt;
                     &lt;/m0:image&gt;
                  &lt;/m0:request&gt;
               &lt;/m0:uploadFileUsingMTOM&gt;
            &lt;/soapenv:Body&gt;
         &lt;/soapenv:Envelope&gt;
--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177413845353217
Content-Type: image/gif
Content-Transfer-Encoding: binary
Content-ID:
         &lt;1.urn:uuid:78F94BC50B68D76FB41177413845003@apache.org&gt;22800GIF89a... &lt;&lt; binary content &gt;&gt;</pre></div>
<div><pre>POST http://localhost:9000/soap/MTOMSwASampleService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:uploadFileUsingSwA
Content-Type: multipart/related; boundary=MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177414170491; type=&quot;text/xml&quot;;
start=&quot;&lt;0.urn:uuid:B94996494E1DD5F9B51177414170492@apache.org&gt;&quot;; charset=UTF-8
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

--MIMEBoundaryurn_uuid_B94996494E1DD5F9B51177414170491225
Content-Type: text/xml; charset=UTF-8
Content-Transfer-Encoding: 8bit
Content-ID:
   &lt;0.urn:uuid:B94996494E1DD5F9B51177414170492@apache.org&gt;22159
      &lt;?xml version='1.0' encoding='UTF-8'?&gt;
         &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
            &lt;soapenv:Body&gt;
               &lt;m0:uploadFileUsingSwA xmlns:m0=&quot;http://www.apache-synapse.org/test&quot;&gt;
                  &lt;m0:request&gt;
                     &lt;m0:imageId&gt;urn:uuid:15FD2DA2584A32BF7C1177414169826&lt;/m0:imageId&gt;
                  &lt;/m0:request&gt;
               &lt;/m0:uploadFileUsingSwA&gt;
            &lt;/soapenv:Body&gt;
         &lt;/soapenv:Envelope&gt;22--34MIMEBoundaryurn_uuid_B94996494E1DD5F9B511774141704912
17
Content-Type: image/gif
Content-Transfer-Encoding: binary
Content-ID:
         &lt;urn:uuid:15FD2DA2584A32BF7C1177414169826&gt;22800GIF89a... &lt;&lt; binary content &gt;&gt;</pre></div>
    <div class="section"><h2>
      <a name="Sample52" id="Sample52">Sample 52: Session less load balancing
      between 3 endpoints</a>
    <a name="Sample_52:_Session_less_load_balancing______between_3_endpoints"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;errorHandler&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;loadbalance&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9001/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9002/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9003/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                    &lt;/loadbalance&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- Send the messages where they have been sent (i.e. implicit To EPR) --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;errorHandler&quot;&gt;

        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;COULDN'T SEND THE MESSAGE TO THE SERVER.&quot;/&gt;
        &lt;/makefault&gt;

        &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;

        &lt;send/&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the simple load balancing among set of
      endpoints</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start Synapse with sample configuration 52. (i.e. synapse -sample 52)
    </p>
    <p>
      Deploy the LoadbalanceFailoverService by switching to &lt;synapse
      installation directory&gt;/samples/axis2Server/src/LoadbalanceFailoverService
      directory and running ant.
    </p>
    <p>
      Start three instances of sample Axis2 server on HTTP ports 9001, 9002 and
      9003 and give some unique names to each server.
    </p>
    <p>
      Example commands to run sample Axis2 servers from the &lt;synapse
      installation directory&gt;/samples/axis2Server directory in Linux are
      listed below:
    </p>
<div><pre>./axis2server.sh -http 9001 -https 9005 -name MyServer1
./axis2server.sh -http 9002 -https 9006 -name MyServer2
./axis2server.sh -http 9003 -https 9007 -name MyServer3</pre></div>
    <p>
      Now we are done with setting up the environment for load balance sample.
      Start the load balance and failover client using the following command:
    </p>
<div><pre>ant loadbalancefailover -Di=100</pre></div>
    <p>
      This client sends 100 requests to the LoadbalanceFailoverService through
      Synapse. Synapse will distribute the load among the three endpoints
      mentioned in the configuration in round-robin manner.
      LoadbalanceFailoverService appends the name of the server to the response,
      so that client can determine which server has processed the message. If
      you examine the console output of the client, you can see that requests
      are processed by three servers as follows:
    </p>
<div><pre>[java] Request: 1 ==&gt; Response from server: MyServer1
[java] Request: 2 ==&gt; Response from server: MyServer2
[java] Request: 3 ==&gt; Response from server: MyServer3
[java] Request: 4 ==&gt; Response from server: MyServer1
[java] Request: 5 ==&gt; Response from server: MyServer2
[java] Request: 6 ==&gt; Response from server: MyServer3
[java] Request: 7 ==&gt; Response from server: MyServer1
...</pre></div>
    <p>
      Now run the client without the -Di=100 parameter to send infinite
      requests. While running the client shutdown the server named MyServer1.
      You can observe that requests are only distributed among MyServer2 and
      MyServer3 after shutting down MyServer1. Console output before and after
      shutting down MyServer1 is listed below (MyServer1 was shutdown after
      request 63):
    </p>
<div><pre>...
[java] Request: 61 ==&gt; Response from server: MyServer1
[java] Request: 62 ==&gt; Response from server: MyServer2
[java] Request: 63 ==&gt; Response from server: MyServer3
[java] Request: 64 ==&gt; Response from server: MyServer2
[java] Request: 65 ==&gt; Response from server: MyServer3
[java] Request: 66 ==&gt; Response from server: MyServer2
[java] Request: 67 ==&gt; Response from server: MyServer3
...</pre></div>
    <p>
      Now restart MyServer1. You can observe that requets will be again sent to
      all three servers roughly after 60 seconds. This is because we have
      specified &lt;suspendDurationOnFailure&gt; as 60 seconds in the
      configuration. Therefore, load balance endpoint will suspend any failed
      child endpoint only for 60 seconds after detecting the failure.
    </p>
    <div class="section"><h2>
      <a name="Sample53" id="Sample53">Sample 53: Failover sending among 3
      endpoints</a>
    <a name="Sample_53:_Failover_sending_among_3______endpoints"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;errorHandler&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;failover&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9001/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9002/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9003/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                                &lt;suspendDurationOnFailure&gt;60&lt;/suspendDurationOnFailure&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                    &lt;/failover&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- Send the messages where they have been sent (i.e. implicit To EPR) --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;errorHandler&quot;&gt;

        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;COULDN'T SEND THE MESSAGE TO THE SERVER.&quot;/&gt;
        &lt;/makefault&gt;

        &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;

        &lt;send/&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the failover sending</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start Synapse with sample configuration 53 (i.e. synapse -sample 53)
    </p>
    <p>
      Deploy the LoadbalanceFailoverService and start three instances of sample
      Axis2 server as mentioned in sample 52.
    </p>
    <p></p>
    <p>
      Above configuration sends messages with the failover behavior. Initially
      the server at port 9001 is treated as primary and other two are treated as
      back ups. Messages are always directed only to the primary server. If the
      primary server has failed, next listed server is selected as the primary.
      Thus, messages are sent successfully as long as there is at least one
      active server. To test this, run the loadbalancefailover client to send
      infinite requests as follows:
    </p>
<div><pre>ant loadbalancefailover</pre></div>
    <p>
      You can see that all requests are processed by MyServer1. Now shutdown
      MyServer1 and inspect the console output of the client. You will observe
      that all subsequent requests are processed by MyServer2.
    </p>
    <p>
      The console output with MyServer1 shutdown after request 127 is listed
      below:
    </p>
<div><pre>...
[java] Request: 125 ==&gt; Response from server: MyServer1
[java] Request: 126 ==&gt; Response from server: MyServer1
[java] Request: 127 ==&gt; Response from server: MyServer1
[java] Request: 128 ==&gt; Response from server: MyServer2
[java] Request: 129 ==&gt; Response from server: MyServer2
[java] Request: 130 ==&gt; Response from server: MyServer2
...</pre></div>
    <p>
      You can keep on shutting down servers like this. Client will get a
      response till you shutdown all listed servers. Once all servers are
      shutdown, the error sequence is activated and a fault message is sent to
      the client as follows.
    </p>
<div><pre>[java] COULDN'T SEND THE MESSAGE TO THE SERVER.</pre></div>
    <p>
      Once a server is detected as failed, it will be added to the active
      servers list again after 60 seconds (specified in &lt;suspendDurationOnFailure&gt;
      in the configuration). Therefore, if you have restarted any of the stopped
      servers and have shutdown all other servers, messages will be directed to
      the newly started server.
    </p>
    <div class="section"><h2>
      <a name="Sample54" id="Sample54">Sample 54: Session affinity load
      balancing between 3 endpoints</a>
    <a name="Sample_54:_Session_affinity_load______balancing_between_3_endpoints"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;errorHandler&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;!-- specify the session as the simple client session provided by Synapse for
                    testing purpose --&gt;
                    <b>&lt;session type=&quot;simpleClientSession&quot;/&gt;</b>

                    &lt;loadbalance&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9001/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9002/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9003/soap/LBService1&quot;&gt;
                                &lt;enableAddressing/&gt;
                            &lt;/address&gt;
                        &lt;/endpoint&gt;
                    &lt;/loadbalance&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- Send the messages where they have been sent (i.e. implicit To EPR) --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;errorHandler&quot;&gt;

        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;COULDN'T SEND THE MESSAGE TO THE SERVER.&quot;/&gt;
        &lt;/makefault&gt;

        &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;

        &lt;send/&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the load balancing with session affinity
      using client initiated sessions</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start Synapse with sample configuration 54 (i.e. synapse -sample 54).
    </p>
    <p>
      Deploy the LoadbalanceFailoverService and start three instances of the
      sample Axis2 server as in sample 52.
    </p>
    <p></p>
    <p>
      Above configuration is same as the load balancing configuration in sample
      52, except that the session type is specified as &quot;simpleClientSession&quot;.
      This is a client initiated session, which means that the client generates
      the session identifier and send it to with each request. In this sample
      session type, client adds a SOAP header named ClientID containing the
      identifier of the client. Synapse binds this ID with a server on the first
      request and sends all seccessive requests containing that ID to the same
      server. Now switch to samples/axis2Client directory and run the client
      using the following command to check this in action.
    </p>
<div><pre>ant loadbalancefailover -Dmode=session</pre></div>
    <p>
      In the session mode, client continuesly sends requests with three diferent
      client (session) IDs. One ID is selected among these three IDs for each
      request randomly. Then client prints the session ID with the responded
      server for each request. Client output for the first 10 requests are shown
      below.
    </p>
<div><pre>[java] Request: 1 Session number: 1 Response from server: MyServer3
[java] Request: 2 Session number: 2 Response from server: MyServer2
[java] Request: 3 Session number: 0 Response from server: MyServer1
[java] Request: 4 Session number: 2 Response from server: MyServer2
[java] Request: 5 Session number: 1 Response from server: MyServer3
[java] Request: 6 Session number: 2 Response from server: MyServer2
[java] Request: 7 Session number: 2 Response from server: MyServer2
[java] Request: 8 Session number: 1 Response from server: MyServer3
[java] Request: 9 Session number: 0 Response from server: MyServer1
[java] Request: 10 Session number: 0 Response from server: MyServer1
... </pre></div>
    <p>
      You can see that session number 0 is always directed to the server named
      MyServer1. That means session number 0 is bound to MyServer1. Similarly
      session 1 and 2 are bound to MyServer3 and MyServer2 respectively.
    </p>
    <div class="section"><h2>
      <a name="Sample55" id="Sample55">Sample 55: Session affinity load
      balancing between fail over endpoints</a>
    <a name="Sample_55:_Session_affinity_load______balancing_between_fail_over_endpoints"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;errorHandler&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;!-- specify the session as the simple client session provided by Synapse for
                    testing purpose --&gt;
                    <b>&lt;session type=&quot;simpleClientSession&quot;/&gt;</b>

                    &lt;loadbalance&gt;
                        &lt;endpoint&gt;
                            &lt;failover&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9001/soap/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9002/soap/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                            &lt;/failover&gt;
                        &lt;/endpoint&gt;
                        &lt;endpoint&gt;
                            &lt;failover&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9003/soap/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                                &lt;endpoint&gt;
                                    &lt;address uri=&quot;http://localhost:9004/soap/LBService1&quot;&gt;
                                        &lt;enableAddressing/&gt;
                                    &lt;/address&gt;
                                &lt;/endpoint&gt;
                            &lt;/failover&gt;
                        &lt;/endpoint&gt;
                    &lt;/loadbalance&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- Send the messages where they have been sent (i.e. implicit To EPR) --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;errorHandler&quot;&gt;

        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;COULDN'T SEND THE MESSAGE TO THE SERVER.&quot;/&gt;
        &lt;/makefault&gt;

        &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;

        &lt;send/&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the session affinity based load
      balancing with failover capability</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start Synapse with sample configuration 55 (i.e. synapse -sample 55).
    </p>
    <p>
      Deploy the LoadbalanceFailoverService and start four sample Axis2 servers
      on http ports 9001, 9002, 9003 and 9004 respectively (make sure to specify
      unconflicting https ports).
    </p>
    <p></p>
    <p>
      This configuration also uses &quot;simpleClientSession&quot; to bind sessions as in
      the previous sample. But failover endpoints are specified as the child
      endpoints of the load balance endpoint. Therefore sessions are bound to
      the failover endpoints. Session information has to be replicated among the
      servers listed under each failover endpoint using some clustering
      mechanism. Therefore, if one endpoint bound to a session failed,
      successive requets for that session will be directed to the next endpoint
      in that failover group. Run the client using the following command to
      observe this behavoir.
    </p>
<div><pre>ant loadbalancefailover -Dmode=session</pre></div>
    <p>
      You can see a client output as shown below.
    </p>
<div><pre>...
[java] Request: 222 Session number: 0 Response from server: MyServer1
[java] Request: 223 Session number: 0 Response from server: MyServer1
[java] Request: 224 Session number: 1 Response from server: MyServer1
[java] Request: 225 Session number: 2 Response from server: MyServer3
[java] Request: 226 Session number: 0 Response from server: MyServer1
[java] Request: 227 Session number: 1 Response from server: MyServer1
[java] Request: 228 Session number: 2 Response from server: MyServer3
[java] Request: 229 Session number: 1 Response from server: MyServer1
[java] Request: 230 Session number: 1 Response from server: MyServer1
[java] Request: 231 Session number: 2 Response from server: MyServer3
...</pre></div>
    <p>
      Note that session 0 is always directed to MyServer1 and session 1 is
      directed to MyServer3. No requests are directed to MyServer2 and MyServer4
      as they are kept as backups by failover endpoints. Now shutdown the server
      named MyServer1 while running the sample. You will observer that all
      successive requests for session 0 is now directed to MyServer2, which is
      the backup server for MyServer1's group. This is shown below, where
      MyServer1 was shutdown after the request 534.
    </p>
<div><pre>...
[java] Request: 529 Session number: 2 Response from server: MyServer3
[java] Request: 530 Session number: 1 Response from server: MyServer1
[java] Request: 531 Session number: 0 Response from server: MyServer1
[java] Request: 532 Session number: 1 Response from server: MyServer1
[java] Request: 533 Session number: 1 Response from server: MyServer1
[java] Request: 534 Session number: 1 Response from server: MyServer1
[java] Request: 535 Session number: 0 Response from server: MyServer2
[java] Request: 536 Session number: 0 Response from server: MyServer2
[java] Request: 537 Session number: 0 Response from server: MyServer2
[java] Request: 538 Session number: 2 Response from server: MyServer3
[java] Request: 539 Session number: 0 Response from server: MyServer2
...</pre></div>
    <div class="section"><h2>
      <a name="Sample56" id="Sample56">Sample 56: WSDL endpoint</a>
    <a name="Sample_56:_WSDL_endpoint"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;!-- get epr from the given wsdl --&gt;
                &lt;endpoint&gt;
                    &lt;wsdl uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot; service=&quot;SimpleStockQuoteService&quot; port=&quot;SimpleStockQuoteServiceSOAP11port_http&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the use of WSDL endpoints</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start the Synapse configuration numbered 56 (i.e. synapse -sample 56).
    </p>
    <p>
      Deploy the SimpleStockQuoteService and start the sample Axis2 server.
    </p>
    <p>
      This sample uses a WSDL endpoint inside the send mediator. WSDL endpoints
      can extract endpoint's address from the given WSDL. As WSDL documents can
      have many services and many ports inside each service, the service and
      port of the required endpoint has to be specified. As with address
      endpoints, QoS parameters for the endpoint can be specified inline in the
      configuration. An excerpt taken from the sample_proxy_1.wsdl containing
      the specified service and port is listed below.
    </p>
<div><pre>&lt;wsdl:service name=&quot;SimpleStockQuoteService&quot;&gt;
    &lt;wsdl:port name=&quot;SimpleStockQuoteServiceSOAP11port_http&quot;
               binding=&quot;axis2:SimpleStockQuoteServiceSOAP11Binding&quot;&gt;
        &lt;soap:address location=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
    &lt;/wsdl:port&gt;
    &lt;wsdl:port name=&quot;SimpleStockQuoteServiceSOAP12port_http&quot;
               binding=&quot;axis2:SimpleStockQuoteServiceSOAP12Binding&quot;&gt;
        &lt;soap12:address location=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
    &lt;/wsdl:port&gt;
&lt;/wsdl:service&gt;</pre></div>
    <p>
      Specified service and port refers to the endpoint address
      &quot;http://localhost:9000/soap/SimpleStockQuoteService&quot; according to the
      above WSDL. Now run the client using the following command.
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080</pre></div>
    <p>
      Client will print the quote price for IBM received from the server running
      on port 9000. Observe the Axis2 console and the Synapse console to verify
      this behavior.
    </p>
    <h1>
      <a name="MessageMediationQoS" id="MessageMediationQoS">Quality of
      Service addition or deduction samples in message mediation</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample100" id="Sample100">Sample 100: Using WS-Security for
      outgoing messages</a>
    <a name="Sample_100:_Using_WS-Security_for______outgoing_messages"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;localEntry key=&quot;sec_policy&quot; src=&quot;file:repository/conf/sample/resources/policy/policy_3.xml&quot;/&gt;

    &lt;in&gt;
        &lt;send&gt;
            &lt;endpoint name=&quot;secure&quot;&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SecureStockQuoteService&quot;&gt;
                    &lt;enableSec policy=&quot;sec_policy&quot;/&gt;
                    &lt;enableAddressing/&gt;
                &lt;/address&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;header name=&quot;wsse:Security&quot; action=&quot;remove&quot;
                xmlns:wsse=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;/&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Connecting to endpoints with WS-Security for
      outgoing messages</b>
    </p>
    <p>
      <b>Prerequisites:</b><br />
    </p>
    <p>
      You may also need to download and install the unlimited strength policy
      files for your JDK before using Apache Rampart (e.g. see
      http://java.sun.com/javase/downloads/index_jdk5.jsp)
    </p>
    <p>
      Start the Synapse configuration numbered 100: i.e. synapse -sample 100<br />
      Start the Axis2 server and deploy the SecureStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      Use the stock quote client to send a request without WS-Security. Synapse
      is configured to enable WS-Security as per the policy specified by
      'policy_3.xml' for the outgoing messages to the SecureStockQuoteService
      endpoint hosted on the Axis2 instance. The debug log messages on Synapse
      shows the encrypted message flowing to the service and the encrypted
      response being received by Synapse. The wsse:Security header is then
      removed from the decrypted message and the response is delivered back to
      the client, as expected. You may execute the client as follows:
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/</pre></div>
    <p>
      The message sent by Synapse to the secure service can be seen as follows,
      when TCPMon is used.
    </p>
<div><pre>POST http://localhost:9001/soap/SecureStockQuoteService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:getQuote
Content-Type: text/xml; charset=UTF-8
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

800
&lt;?xml version='1.0' encoding='UTF-8'?&gt;
   &lt;soapenv:Envelope xmlns:xenc=&quot;http://www.w3.org/2001/04/xmlenc#&quot; xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot; ..&gt;
      &lt;soapenv:Header&gt;
         &lt;wsse:Security ..&gt;
            &lt;wsu:Timestamp ..&gt;
               ...
            &lt;/wsu:Timestamp&gt;
            &lt;xenc:EncryptedKey..&gt;
               ...
            &lt;/xenc:EncryptedKey&gt;
            &lt;wsse:BinarySecurityToken ...&gt;
               &lt;ds:SignedInfo&gt;
               ...
               &lt;/ds:SignedInfo&gt;
               &lt;ds:SignatureValue&gt;
               ...
               &lt;/ds:SignatureValue&gt;
               &lt;ds:KeyInfo Id=&quot;KeyId-29551621&quot;&gt;
                  ...
               &lt;/ds:KeyInfo&gt;
            &lt;/ds:Signature&gt;
         &lt;/wsse:Security&gt;
         &lt;wsa:To&gt;http://localhost:9001/soap/SecureStockQuoteService&lt;/wsa:To&gt;
         &lt;wsa:MessageID&gt;urn:uuid:1C4CE88B8A1A9C09D91177500753443&lt;/wsa:MessageID&gt;
         &lt;wsa:Action&gt;urn:getQuote&lt;/wsa:Action&gt;
      &lt;/soapenv:Header&gt;
      &lt;soapenv:Body xmlns:wsu=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot; wsu:Id=&quot;Id-3789605&quot;&gt;
         &lt;xenc:EncryptedData Id=&quot;EncDataId-3789605&quot; Type=&quot;http://www.w3.org/2001/04/xmlenc#Content&quot;&gt;
            &lt;xenc:EncryptionMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#aes256-cbc&quot; /&gt;
            &lt;xenc:CipherData&gt;
                &lt;xenc:CipherValue&gt;Layg0xQcnH....6UKm5nKU6Qqr&lt;/xenc:CipherValue&gt;
            &lt;/xenc:CipherData&gt;
         &lt;/xenc:EncryptedData&gt;
      &lt;/soapenv:Body&gt;
   &lt;/soapenv:Envelope&gt;0</pre></div>
    <div class="section"><h2>
      <a name="Sample101" id="Sample101">Sample 101: Reliable message
      exchange between Synapse and the back-end server using
      WS-ReliableMessaging</a>
    <a name="Sample_101:_Reliable_message______exchange_between_Synapse_and_the_back-end_server_using______WS-ReliableMessaging"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;in&gt;
        &lt;RMSequence single=&quot;true&quot; version=&quot;1.0&quot;/&gt;
        &lt;send&gt;
           &lt;endpoint name=&quot;reliable&quot;&gt;
              &lt;address uri=&quot;http://localhost:9000/soap/ReliableStockQuoteService&quot;&gt;
                 &lt;enableRM/&gt;
                 &lt;enableAddressing/&gt;
              &lt;/address&gt;
           &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;header name=&quot;wsrm:SequenceAcknowledgement&quot; action=&quot;remove&quot;
                xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;/&gt;
        &lt;header name=&quot;wsrm:Sequence&quot; action=&quot;remove&quot;
                xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;/&gt;
        &lt;send/&gt;
    &lt;/out&gt;

&lt;/definitions&gt;</pre></div>
    <b>Objective: Demonstrate the message exchange between Synapse and
    the server using WS-ReliableMessaging (WS-RM)</b>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Deploy the ReliableStockQuoteService in the sample Axis2 server by
      switching to the samples/axis2Server/src/ReliableStockQuoteService
      directory and running ant.
    </p>
    <p>
      Start the sample Axis2 server on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 101 (i.e. synapse -sample
      101).
    </p>
    <p></p>
    <p>
      In the above configuration, WS-RM is engaged to the endpoint using the
      &lt;enableRM/&gt; tag. It is possible to engage WS-RM to both Address and
      WSDL endpoints using this tag. In addition to the RM enabled endpoint,
      RMSequence mediator is specified before the send mediator. This mediator
      is used to specify the set of messages to be sent using a single RM
      sequence. In this sample it is specified as single message per sequence.
      It also specifies the version of the WS-RM to be used. Refer to the
      Synapse configuration language documentation for more information about
      the RMSequence mediator. RM related SOAP headers are removed form the
      message in the out mediator as WS-RM message exchange happens only between
      the Synapse and the server. Now run the sample client using the following
      command.
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080</pre></div>
    <p>
      You can observer the client output displaying the quote price for IBM as
      follows:
    </p>
<div><pre>[java] Standard :: Stock price = $189.2521262517493</pre></div>
    <p>
      There is no difference to be observed between the normal message exchange
      and WS-RM enabled message exchange as far as client and server outputs are
      considered. But if you look at the wire level messages, you would observe
      additional WS-RM messages and WS-RM elements. Synapse, the initiator of
      the RM sequence, first try to create a sequence by sending a message with
      CreateSequence element.
    </p>
<div><pre>...
&lt;soapenv:Body&gt;
   &lt;wsrm:CreateSequence xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;&gt;
      &lt;wsrm:AcksTo&gt;
         &lt;wsa:Address&gt;http://www.w3.org/2005/08/addressing/anonymous&lt;/wsa:Address&gt;
      &lt;/wsrm:AcksTo&gt;
      &lt;wsrm:Offer&gt;
         &lt;wsrm:Identifier&gt;urn:uuid:546F6F33FB7D8BBE351179807372769&lt;/wsrm:Identifier&gt;
      &lt;/wsrm:Offer&gt;
   &lt;/wsrm:CreateSequence&gt;
&lt;/soapenv:Body&gt;
...</pre></div>
    <p>
      Sample Axis2 server responds to CreateSequence request with the following
      message:
    </p>
<div><pre>...
&lt;soapenv:Body&gt;
   &lt;wsrm:CreateSequenceResponse xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;&gt;
      &lt;wsrm:Identifier&gt;urn:uuid:879853A6871A66641C1179807373270&lt;/wsrm:Identifier&gt;
      &lt;wsrm:Accept&gt;
         &lt;wsrm:AcksTo&gt;
            &lt;wsa:Address&gt;http://localhost:9000/soap/ReliableStockQuoteService&lt;/wsa:Address&gt;
         &lt;/wsrm:AcksTo&gt;
      &lt;/wsrm:Accept&gt;
   &lt;/wsrm:CreateSequenceResponse&gt;
&lt;/soapenv:Body&gt;
...</pre></div>
    <p>
      Once the sequence is established, Synapse sends the request to the server
      with the pre-negotiated sequence ID.
    </p>
<div><pre>&lt;soapenv:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;
                  xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
    &lt;soapenv:Header&gt;
        &lt;wsa:To&gt;http://localhost:9000/soap/ReliableStockQuoteService&lt;/wsa:To&gt;
        &lt;wsa:MessageID&gt;urn:uuid:DB9A5257B637DDA38B1179807372560712002-1515891720&lt;/wsa:MessageID&gt;
        &lt;wsa:Action&gt;urn:getQuote&lt;/wsa:Action&gt;
        &lt;wsrm:Sequence xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;
                       soapenv:mustUnderstand=&quot;1&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:879853A6871A66641C1179807373270&lt;/wsrm:Identifier&gt;
            &lt;wsrm:MessageNumber&gt;1&lt;/wsrm:MessageNumber&gt;
            &lt;wsrm:LastMessage/&gt;
        &lt;/wsrm:Sequence&gt;
    &lt;/soapenv:Header&gt;
    &lt;soapenv:Body&gt;
        &lt;m0:getQuote xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
            &lt;m0:request&gt;
                &lt;m0:symbol&gt;IBM&lt;/m0:symbol&gt;
            &lt;/m0:request&gt;
        &lt;/m0:getQuote&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      Synapse keeps on sending above message till the server responds with a
      valid response message with 200 OK HTTP header. If the server is not ready
      with a response, it will respond with 202 Accepted HTTP header for all
      requests. Once the server is ready with a response it will send the
      response message with sequence ID as follows.
    </p>
<div><pre>&lt;soapenv:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;
                  xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
    &lt;soapenv:Header&gt;
        &lt;wsa:MessageID&gt;urn:uuid:879853A6871A66641C1179807373804&lt;/wsa:MessageID&gt;
        &lt;wsa:Action&gt;http://services.samples/ReliableStockQuoteServicePortType/getQuoteResponse
        &lt;/wsa:Action&gt;
        &lt;wsa:RelatesTo&gt;urn:uuid:DB9A5257B637DDA38B1179807372560712002-1515891720&lt;/wsa:RelatesTo&gt;
        &lt;wsrm:Sequence xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;
                       soapenv:mustUnderstand=&quot;1&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:546F6F33FB7D8BBE351179807372769&lt;/wsrm:Identifier&gt;
            &lt;wsrm:MessageNumber&gt;1&lt;/wsrm:MessageNumber&gt;
            &lt;wsrm:LastMessage/&gt;
        &lt;/wsrm:Sequence&gt;
        &lt;wsrm:SequenceAcknowledgement xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;
                                      soapenv:mustUnderstand=&quot;1&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:879853A6871A66641C1179807373270&lt;/wsrm:Identifier&gt;
            &lt;wsrm:AcknowledgementRange Lower=&quot;1&quot; Upper=&quot;1&quot;/&gt;
        &lt;/wsrm:SequenceAcknowledgement&gt;
    &lt;/soapenv:Header&gt;
    &lt;soapenv:Body&gt;
        &lt;ns:getQuoteResponse xmlns:ns=&quot;http://services.samples/xsd&quot;&gt;
...</pre></div>
    <p>
      Now both Synapse and the server are done with the actual message exchange.
      Then Synapse sends a request to terminate the sequence as follows:
    </p>
<div><pre>&lt;soapenv:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;
                  xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
    &lt;soapenv:Header&gt;
        &lt;wsa:To&gt;http://localhost:9000/soap/ReliableStockQuoteService&lt;/wsa:To&gt;
        &lt;wsa:MessageID&gt;urn:uuid:546F6F33FB7D8BBE351179807379591&lt;/wsa:MessageID&gt;
        &lt;wsa:Action&gt;http://schemas.xmlsoap.org/ws/2005/02/rm/TerminateSequence&lt;/wsa:Action&gt;
        &lt;wsrm:SequenceAcknowledgement xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;
                                      soapenv:mustUnderstand=&quot;1&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:546F6F33FB7D8BBE351179807372769&lt;/wsrm:Identifier&gt;
            &lt;wsrm:AcknowledgementRange Lower=&quot;1&quot; Upper=&quot;1&quot;/&gt;
        &lt;/wsrm:SequenceAcknowledgement&gt;
    &lt;/soapenv:Header&gt;
    &lt;soapenv:Body&gt;
        &lt;wsrm:TerminateSequence xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:879853A6871A66641C1179807373270&lt;/wsrm:Identifier&gt;
        &lt;/wsrm:TerminateSequence&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      Server responds to the sequence termination message, accepting to
      terminate the sequence as follows.
    </p>
<div><pre>&lt;soapenv:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;
                  xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
    &lt;soapenv:Header&gt;
        &lt;wsa:ReplyTo&gt;
            &lt;wsa:Address&gt;http://localhost:9000/soap/ReliableStockQuoteService&lt;/wsa:Address&gt;
        &lt;/wsa:ReplyTo&gt;
        &lt;wsa:MessageID&gt;urn:uuid:879853A6871A66641C1179807380190&lt;/wsa:MessageID&gt;
        &lt;wsa:Action&gt;http://schemas.xmlsoap.org/ws/2005/02/rm/TerminateSequence&lt;/wsa:Action&gt;
    &lt;/soapenv:Header&gt;
    &lt;soapenv:Body&gt;
        &lt;wsrm:TerminateSequence xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;&gt;
            &lt;wsrm:Identifier&gt;urn:uuid:546F6F33FB7D8BBE351179807372769&lt;/wsrm:Identifier&gt;
        &lt;/wsrm:TerminateSequence&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      Note that although each of above messages are separate SOAP messages, in
      most cases they will be exchanged in a single socket connection as HTTP
      Keep-Alive header is used.
    </p>
    <h1>
      <a name="ProxyServices" id="ProxyServices">Synapse Proxy service
      samples</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample150" id="Sample150">Sample 150: Introduction to proxy
      services</a>
    <a name="Sample_150:_Introduction_to_proxy______services"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduction to Synapse proxy services</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 150: i.e. synapse -sample 150<br /> Start the
      Axis2 server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p></p>
    <p>
      Once Synapse starts, you could go to
      http://localhost:8080/soap/StockQuoteProxy?wsdl and view the WSDL
      generated for the proxy service defined in the configuration. This WSDL is
      based on the source WSDL supplied in the proxy service definition, and is
      updated to reflect the proxy service EPR.
    </p>
    <p>
      Execute the stock quote client by requesting for a stock quote on the
      proxy service as follows:
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy</pre></div>
    <p>
      An 'inSequence' or 'endpoint' or both of these would decide how the
      message would be handled after the proxy service receives the message. In
      the above example, the request received is forwarded to the sample service
      hosted on Axis2. The 'outSequence' defines how the response is handled
      before it is sent back to the client. By default, a proxy service is
      exposed over all transports configured for Synapse, unless these are
      specifically mentioned through the 'transports' attribute.
    </p>
    <div class="section"><h2>
      <a name="Sample151" id="Sample151">Sample 151: Custom sequences and
      endpoints with proxy services</a>
    <a name="Sample_151:_Custom_sequences_and______endpoints_with_proxy_services"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;proxy_1&quot;&gt;
        &lt;send&gt;
            &lt;endpoint&gt;&lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;&lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;
    &lt;sequence name=&quot;out&quot;&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;
    &lt;endpoint name=&quot;proxy_2_endpoint&quot;&gt;
        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
    &lt;/endpoint&gt;
    &lt;localEntry key=&quot;proxy_wsdl&quot; src=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;

    &lt;proxy name=&quot;StockQuoteProxy1&quot;&gt;
        &lt;publishWSDL key=&quot;proxy_wsdl&quot;/&gt;
        &lt;target inSequence=&quot;proxy_1&quot; outSequence=&quot;out&quot;/&gt;
    &lt;/proxy&gt;

    &lt;proxy name=&quot;StockQuoteProxy2&quot;&gt;
        &lt;publishWSDL key=&quot;proxy_wsdl&quot;/&gt;
        &lt;target endpoint=&quot;proxy_2_endpoint&quot; outSequence=&quot;out&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Using custom sequences and endpoints for message
      mediation with proxy services</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 151: i.e. synapse -sample 151<br /> Start the
      Axis2 server and deploy the SimpleStockQuoteService if not already done
    </p>
    <p></p>
    <p>
      This configuration creates two proxy services.. The first proxy service
      'StockQuoteProxy1' uses the sequence named 'proxy_1' to process incoming
      messages and the sequence named &quot;out&quot; to process outgoing responses. The
      second proxy service 'StockQuoteProxy2' is set to directly forward
      messages that are received to the endpoint named 'proxy_2_endpoint'
      without any mediation.
    </p>
    <p>
      You could send a stock quote request to each of these proxy services and
      receive the reply generated by the actual service hosted on the Axis2
      instance.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy1ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy2</pre></div>
    <div class="section"><h2>
      <a name="Sample152" id="Sample152">Sample 152: Switching transports and
      message format from SOAP to REST/POX</a>
    <a name="Sample_152:_Switching_transports_and______message_format_from_SOAP_to_RESTPOX"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;https&quot;&gt;
        &lt;target&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot; format=&quot;pox&quot;/&gt;
            &lt;/endpoint&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Switching transports and from SOAP to REST/POX</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Synapse
      configuration numbered 152: i.e. synapse -sample 152
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      This configuration demonstrates how a proxy service could be exposed on a
      subset of available transports, and how it could switch from one transport
      to another. This example exposes the created proxy service only on https,
      and thus if the user tries to access it over http, would result in a
      fault.
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuoteProxy
...
     [java] org.apache.axis2.AxisFault: The service cannot be found for the endpoint reference (EPR) /soap/StockQuoteProxy</pre></div>
    <p></p>
    <p>
      Accessing this over https (ant stockquote
      -Dtrpurl=https://localhost:8443/soap/StockQuoteProxy) causes the proxy
      service to access the SimpleStockQuoteService on the sample Axis2 server
      using REST/POX. This could be seen if the message exchange was captured
      using TCPMon as follows. The REST/POX response is now transformed back
      into a SOAP message and returned to the client.
    </p>
<div><pre>POST http://localhost:9000/soap/SimpleStockQuoteService HTTP/1.1
Host: 127.0.0.1
SOAPAction: urn:getQuote
Content-Type: application/xml; charset=UTF-8;action=&quot;urn:getQuote&quot;;
Transfer-Encoding: chunked
Connection: Keep-Alive
User-Agent: Synapse-HttpComponents-NIO

75
&lt;m0:getQuote xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
   &lt;m0:request&gt;
      &lt;m0:symbol&gt;IBM&lt;/m0:symbol&gt;
   &lt;/m0:request&gt;
&lt;/m0:getQuote&gt;</pre></div>
<div><pre>HTTP/1.1 200 OK
Content-Type: application/xml; charset=UTF-8;action=&quot;http://services.samples/SimpleStockQuoteServicePortType/getQuoteResponse&quot;;
Date: Tue, 24 Apr 2007 14:42:11 GMT
Server: Synapse-HttpComponents-NIO
Transfer-Encoding: chunked
Connection: Keep-Alive

2b3
&lt;ns:getQuoteResponse xmlns:ns=&quot;http://services.samples/xsd&quot;&gt;
   &lt;ns:return&gt;
      &lt;ns:change&gt;3.7730036841862384&lt;/ns:change&gt;
      &lt;ns:earnings&gt;-9.950236235550818&lt;/ns:earnings&gt;
      &lt;ns:high&gt;-80.23868444613285&lt;/ns:high&gt;
      &lt;ns:last&gt;80.50750970812187&lt;/ns:last&gt;
      &lt;ns:lastTradeTimestamp&gt;Tue Apr 24 20:42:11 LKT 2007&lt;/ns:lastTradeTimestamp&gt;
      &lt;ns:low&gt;-79.67368355714606&lt;/ns:low&gt;
      &lt;ns:marketCap&gt;4.502043663670823E7&lt;/ns:marketCap&gt;
      &lt;ns:name&gt;IBM Company&lt;/ns:name&gt;
      &lt;ns:open&gt;-80.02229531286982&lt;/ns:open&gt;
      &lt;ns:peRatio&gt;25.089295161182022&lt;/ns:peRatio&gt;
      &lt;ns:percentageChange&gt;4.28842665653824&lt;/ns:percentageChange&gt;
      &lt;ns:prevClose&gt;87.98107059692451&lt;/ns:prevClose&gt;
      &lt;ns:symbol&gt;IBM&lt;/ns:symbol&gt;
      &lt;ns:volume&gt;19941&lt;/ns:volume&gt;
   &lt;/ns:return&gt;&lt;/ns:getQuoteResponse&gt;</pre></div>
    <p></p>
    <div class="section"><h2>
      <a name="Sample153" id="Sample153">Sample 153: Routing the messages
      arrived to a proxy service without processing the security headers</a>
    <a name="Sample_153:_Routing_the_messages______arrived_to_a_proxy_service_without_processing_the_security_headers"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;send&gt;
                    &lt;endpoint&gt;
                        &lt;address uri=&quot;http://localhost:9000/soap/SecureStockQuoteService&quot;/&gt;
                    &lt;/endpoint&gt;
                &lt;/send&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Routing the messages arrived to a proxy service
      without processing the MustUnderstand headers (Security header)</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> You may also need to
      download and install the unlimited strength policy files for your JDK
      before using Apache Rampart (e.g. see
      http://java.sun.com/javase/downloads/index_jdk5.jsp)
    </p>
    <p>
      Start the Synapse configuration numbered 153: i.e. synapse -sample 153<br />
      Start the Axis2 server and deploy the SecureStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      The proxy service will recieve secure messages with security headers which
      are MustUnderstand. But hence element 'engageSec' is not present in the
      proxy configuration synapse will not engage that Apache Rampart on this
      proxy service. It is expected that an MustUnderstand failure exception on
      the AxisEngine would occur before the message arrives Synapse. But Synapse
      handles this message and gets it in by setting all the headers which are
      MustUnderstand and not processed to processed state. This will enable
      synapse to route the messages without reading the Security headers (just
      routing the messages from client to service, both of which are secure). To
      execute the client, send a stock quote request to the proxy service, and
      sign and encrypt the request by specifying the client side security policy
      as follows:
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuoteProxy -Dpolicy=./../../repository/conf/sample/resources/policy/client_policy_3.xml</pre></div>
    <p>
      By following through the debug logs or TCPMon output, you could see that
      the request received by the proxy service was signed and encrypted. Also,
      looking up the WSDL of the proxy service by requesting the URL
      http://localhost:8080/soap/StockQuoteProxy?wsdl reveals the security
      policy attachments are not there and security is not engaged. When sending
      the message to the backend service, you could verify that the security
      headers were there as in the original message to synapse from client, and
      that the response received does use WS-Security, and forwarded back to the
      client without any modification. You should note that this wont be a
      security hole because the message inside synapse is signed and encrypted
      and can only be forwarded to a secure service to be useful.
    </p>
    <h1>
      <a name="ProxyServiceQoS" id="ProxyServiceQoS">QoS addition and
      deduction for service mediation (proxy) samples</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample200" id="Sample200">Sample 200: Using WS-Security with
      policy attachments for proxy services</a>
    <a name="Sample_200:_Using_WS-Security_with______policy_attachments_for_proxy_services"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;localEntry key=&quot;sec_policy&quot; src=&quot;file:repository/conf/sample/resources/policy/policy_3.xml&quot;/&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;header name=&quot;wsse:Security&quot; action=&quot;remove&quot;
                        xmlns:wsse=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;/&gt;
                &lt;send&gt;
                    &lt;endpoint&gt;
                        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                    &lt;/endpoint&gt;
                &lt;/send&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
        &lt;policy key=&quot;sec_policy&quot;/&gt;
        &lt;enableSec/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Using WS-Security signing and encryption with proxy
      services through WS-Policy</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> You may also need to
      download and install the unlimited strength policy files for your JDK
      before using Apache Rampart (e.g. see
      http://java.sun.com/javase/downloads/index_jdk5.jsp)
    </p>
    <p>
      Start the Synapse configuration numbered 200: i.e. synapse -sample 200<br />
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      The proxy service expects to receive a signed and encrypted message as
      specified by the security policy. Please see Apache Rampart and Axis2
      documentation on the format of the policy file. The element 'engageSec'
      specifies that Apache Rampart should be engaged on this proxy service.
      Hence if Rampart rejects any request messages that does not conform to the
      specified policy, those messages will never reach the 'inSequence' to be
      processed. Since the proxy service is forwarding the received request to
      the simple stock quote service that does not use WS-Security, we are
      instructing Synapse to remove the wsse:Security header from the outgoing
      message. To execute the client, send a stock quote request to the proxy
      service, and sign and encrypt the request by specifying the client side
      security policy as follows:
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuoteProxy -Dpolicy=./../../repository/conf/sample/resources/policy/client_policy_3.xml</pre></div>
    <p>
      By following through the debug logs or TCPMon output, you could see that
      the request received by the proxy service was signed and encrypted. Also,
      looking up the WSDL of the proxy service by requesting the
      URLhttp://localhost:8080/soap/StockQuoteProxy?wsdl reveals the security
      policy attachment to the supplied base WSDL. When sending the message to
      the backend service, you could verify that the security headers were
      removed, and that the response received does not use WS-Security, but that
      the response being forwarded back to the client is signed and encrypted as
      expected by the client.
    </p>
    <div class="section"><h2>
      <a name="Sample201" id="Sample201">Sample 201: Reliable message
      exchange between the client and proxy services using WS-ReliableMessaging</a>
    <a name="Sample_201:_Reliable_message______exchange_between_the_client_and_proxy_services_using_WS-ReliableMessaging"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;header name=&quot;wsrm:SequenceAcknowledgement&quot; action=&quot;remove&quot;
                        xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;/&gt;
                &lt;header name=&quot;wsrm:Sequence&quot; action=&quot;remove&quot;
                        xmlns:wsrm=&quot;http://schemas.xmlsoap.org/ws/2005/02/rm&quot;/&gt;
                &lt;send&gt;
                    &lt;endpoint&gt;
                        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                    &lt;/endpoint&gt;
                &lt;/send&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
        &lt;enableRM/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <b>Objective: Demonstrate the reliable message exchange between the
    client and Synapse using WS-ReliableMessaging (WS-RM)</b>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Deploy the SimpleStockQuoteService in the sample Axis2 server and start it
      on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration number 201 (i.e. synapse
      -sample 201).
    </p>
    <p></p>
    <p>
      In the above configuration, a proxy service is created with WS-RM enabled
      using the &lt;enableRM/&gt; tag. Therefore, this proxy service is capable
      of communicating with a WS-RM client. It also removes the WS-RM headers in
      the In Sequence before the message is sent to the back end server. This is
      required as the reliable messaging is applicable only between the client
      and Synapse. Now start the client with WS-RM as follows:
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080/soap/StockQuoteProxy -Dwsrm=true</pre></div>
    <p>
      In this case, client sends WS-RM enabled request to Synapse where Synapse
      sends normal request to the server. This can be observed by examining the
      wire level messages between the client and Synapse. These messages would
      be similar to the wire level messages shown in sample 53. Each message
      would perform a similar function to the messages discussed in sample 53.
    </p>
    <p></p>
    <h1>
      <a name="Transport" id="Transport">Transport samples and switching
      transports</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample250" id="Sample250">Sample 250: Introduction to
      switching transports - JMS to http/s</a>
    <a name="Sample_250:_Introduction_to______switching_transports_-_JMS_to_https"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;jms&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
            &lt;/inSequence&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduction to switching transports with proxy
      services</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Axis2 server
      and deploy the SimpleStockQuoteService (Refer steps above)<br />
      Download, install and start a JMS server, and configure Synapse to listen
      on JMS (refer notes below)<br /> Start the Synapse configuration
      numbered 250: i.e. synapse -sample 250<br /> For this example we would
      use ActiveMQ as the JMS provider. Once ActiveMQ is installed and started
      you should get a message as follows:
    </p>
<div><pre>INFO BrokerService - ActiveMQ JMS Message Broker (localhost) started</pre></div>
    <p>
      You will now need to configure the Axis2 instance used by Synapse (not the
      sample Axis2 server) to enable JMS support using the above provider. Refer
      to the Axis2 documentation on setting up JMS for more details
      (http://ws.apache.org/axis2/1_1/jms-transport.html). You will also need to
      copy the ActiveMQ client jar files activeio-core-3.0-beta1.jar,
      activemq-core-4.0-RC2.jar and geronimo-j2ee-management_1.0_spec-1.0.jar
      into the lib directory to allow Synapse to connect to the JMS provider.
    </p>
    <p>
      For a default ActiveMQ v4.0 installation, you may uncomment the Axis2
      transport listener configuration found at repository/conf/axis2.xml as
    </p>
<div><pre>&lt;transportReceiver name=&quot;jms&quot; class=&quot;org.apache.axis2.transport.jms.JMSListener&quot;&gt; ...</pre></div>
    <p>
      Once you start the Synapse configuration and request for the WSDL of the
      proxy service (http://localhost:8080/soap/StockQuoteProxy?wsdl) you will
      notice that its exposed only on the JMS transport. This is because the
      configuration specified this requirement in the proxy service definition.
    </p>
    <p>
      Now lets send a stock quote request on JMS, using the dumb stock quote
      client as follows:
    </p>
<div><pre>ant jmsclient -Djms_type=pox -Djms_dest=dynamicQueues/StockQuoteProxy -Djms_payload=MSFT</pre></div>
    <p>
      On the Synapse debug log you will notice that the JMS listener received
      the request message as:
    </p>
<div><pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver -Proxy Service StockQuoteProxy received a new message...</pre></div>
    <p>
      Now if you examine the console running the sample Axis2 server, you will
      see a message indicating that the server has accepted an order as follows:
    </p>
<div><pre>Accepted order for : 16517 stocks of MSFT at $ 169.14622538721846</pre></div>
    <p>
      In this sample, client sends the request message to the proxy service
      exposed in JMS in Synsape. Synapse forwards this message to the HTTP EPR
      of the simple stock quote service hosted on the sample Axis2 server, and
      returns the reply back to the client through a JMS temporary queue.
    </p>
    <p>
      Note: It is possible to instruct a JMS proxy service to listen to an
      already existing destination without creating a new one. To do this, use
      the property elements on the proxy service definition to specify the
      destination and connection factory etc.
    </p>
    <p>
      e.g.
    </p>
<div><pre>&lt;property name=&quot;transport.jms.Destination&quot; value=&quot;dynamicTopics/something.TestTopic&quot;/&gt;</pre></div>
    <div class="section"><h2>
      <a name="Sample251" id="Sample251">Sample 251: Switching from http/s to
      JMS</a>
    <a name="Sample_251:_Switching_from_https_to______JMS"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;http&quot;&gt;
        &lt;target&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;jms:/SimpleStockQuoteService?transport.jms.ConnectionFactoryJNDIName=QueueConnectionFactory&amp;amp;
                   java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory&amp;amp;java.naming.provider.url=tcp://localhost:61616&quot;/&gt;
            &lt;/endpoint&gt;
            &lt;inSequence&gt;
                &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate switching from HTTP to JMS</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Download, install and
      start a JMS server
    </p>
    <p>
      Configure sample Axis2 server for JMS (refer notes above)<br /> Start
      the Axis2 server and deploy the SimpleStockQuoteService (see below)<br />
      Configure the Synase JMS transport (refer notes above - sample 250)<br />
      Start the Synapse configuration numbered 251: i.e. synapse -sample 251
    </p>
    <p>
      To switch from HTTP to JMS, edit the
      samples/axis2Server/repository/conf/axis2.xml for the sample Axis2 server
      and enable JMS (refer notes above), and restart the server. Now you can
      see that the simple stock quote service is available in both JMS and HTTP
      in the sample Axis2 server. To see this, point your browser to the WSDL of
      the service at http://localhost:9000/soap/SimpleStockQuoteService?wsdl.
      JMS URL for the service is mentioned as below:
    </p>
<div><pre>jms:/SimpleStockQuoteService?transport.jms.ConnectionFactoryJNDIName=
QueueConnectionFactory&amp;java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory&amp;
java.naming.provider.url=tcp://localhost:61616</pre></div>
    <p>
      You may also notice that the simple stock quote proxy service exposed in
      Synapse is now available only in HTTP as we have specified transport for
      that service as HTTP. To observe this, access the WSDL of stock quote
      proxy service at http://localhost:8080/soap/StockQuoteProxy?wsdl.
    </p>
    <p>
      This Synapse configuration creates a proxy service over HTTP and forwards
      received messages to the above EPR using JMS, and sends back the response
      to the client over HTTP once the simple stock quote service responds with
      the stock quote reply over JMS to the Synapse server. To test this, send a
      place order request to Synapse using HTTP as follows:
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy -Dmode=placeorder -Dsymbol=MSFT</pre></div>
    <p>
      The sample Axis2 server console will print a message indicating that it
      has accepted the order as follows:
    </p>
<div><pre>Accepted order for : 18406 stocks of MSFT at $ 83.58806051152119</pre></div>
    <div class="section"><h2>
      <a name="Sample252" id="Sample252">Sample 252: Pure text/binary and POX
      message support with JMS</a>
    <a name="Sample_252:_Pure_textbinary_and_POX______message_support_with_JMS"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;text_proxy&quot;&gt;
        &lt;header name=&quot;Action&quot; value=&quot;urn:placeOrder&quot;/&gt;
        &lt;script language=&quot;js&quot;&gt;&lt;![CDATA[
            var args = mc.getPayloadXML().toString().split(&quot; &quot;);
            mc.setPayloadXML(
            &lt;m:placeOrder xmlns:m=&quot;http://services.samples/xsd&quot;&gt;
                &lt;m:order&gt;
                    &lt;m:price&gt;{args[0]}&lt;/m:price&gt;
                    &lt;m:quantity&gt;{args[1]}&lt;/m:quantity&gt;
                    &lt;m:symbol&gt;{args[2]}&lt;/m:symbol&gt;
                &lt;/m:order&gt;
            &lt;/m:placeOrder&gt;);
        ]]&gt;&lt;/script&gt;
        &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;mtom_proxy&quot;&gt;
        &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
        &lt;header name=&quot;Action&quot; value=&quot;urn:oneWayUploadUsingMTOM&quot;/&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/MTOMSwASampleService&quot; optimize=&quot;mtom&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;pox_proxy&quot;&gt;
        &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
        &lt;header name=&quot;Action&quot; value=&quot;urn:placeOrder&quot;/&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot; format=&quot;soap11&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;out&quot;&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;

    &lt;proxy name=&quot;JMSFileUploadProxy&quot; transports=&quot;jms&quot;&gt;
        &lt;target inSequence=&quot;mtom_proxy&quot; outSequence=&quot;out&quot;/&gt;
        &lt;parameter name=&quot;transport.jms.Wrapper&quot;&gt;{http://services.samples/xsd}element&lt;/parameter&gt;
    &lt;/proxy&gt;
    &lt;proxy name=&quot;JMSTextProxy&quot; transports=&quot;jms&quot;&gt;
        &lt;target inSequence=&quot;text_proxy&quot; outSequence=&quot;out&quot;/&gt;
        &lt;parameter name=&quot;transport.jms.Wrapper&quot;&gt;{http://services.samples/xsd}text&lt;/parameter&gt;
    &lt;/proxy&gt;
    &lt;proxy name=&quot;JMSPoxProxy&quot; transports=&quot;jms&quot;&gt;
        &lt;target inSequence=&quot;pox_proxy&quot; outSequence=&quot;out&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Pure POX/Text and Binary JMS Proxy services -
      including MTOM</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Configure JMS for Synapse
      (Refer notes)<br /> Start the Synapse configuration numbered 252: i.e.
      synapse -sample 252<br /> Start the Axis2 server and deploy the
      SimpleStockQuoteService and the MTOMSwASampleService if not already done
    </p>
    <p></p>
    <p>
      This configuration creates three JMS proxy services named
      JMSFileUploadProxy, JMSTextProxy and JMSPoxProxy exposed over JMS queues
      with the same names as the services. The first part of this example
      demonstrates the pure text message support with JMS, where a user sends a
      space separated text JMS message of the form &quot;&lt;price&gt; &lt;qty&gt;
      &lt;symbol&gt;&quot;. Synapse converts this message into a SOAP message and
      sends this to the SimpleStockQuoteServices' placeOrder operation. Synapse
      uses the script mediator to transform the text message into a XML payload
      using the Javascript support available to tokenize the string. The proxy
      service property named &quot;transport.jms.Wrapper&quot; defines a custom wrapper
      element QName, to be used when wrapping text/binary content into a SOAP
      envelope.
    </p>
    <p></p>
    <p>
      Execute JMS client as follows. This will post a pure text JMS message with
      the content defined (e.g. &quot;12.33 1000 ACP&quot;) to the specified JMS
      destination - dynamicQueues/JMSTextProxy
    </p>
<div><pre>ant jmsclient -Djms_type=text -Djms_payload=&quot;12.33 1000 ACP&quot; -Djms_dest=dynamicQueues/JMSTextProxy</pre></div>
    <p>
      Following the debug logs, you could notice that Synapse received the JMS
      text message and transformed it into a SOAP payload as follows. Notice
      that the wrapper element &quot;{http://services.samples/xsd}text&quot; has been used
      to hold the text message content.
    </p>
<div><pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
  &lt;soapenv:Body&gt;&lt;axis2ns1:text xmlns:axis2ns1=&quot;http://services.samples/xsd&quot;&gt;12.33 1000 ACP&lt;/axis2ns1:text&gt;&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      Now, you could see how the script mediator created a stock quote request
      by tokenizing the text as follows, and sent the message to the placeOrder
      operation of the SimpleStockQuoteService.
    </p>
<div><pre>[JMSWorker-1] DEBUG AddressEndpoint - Sending message to endpoint :: name = AnonymousEndpoints resolved address = http://localhost:9000/soap/SimpleStockQuoteService
[JMSWorker-1] DEBUG AddressEndpoint - SOAPAction: urn:placeOrder
[JMSWorker-1] DEBUG AddressEndpoint - WSA-Action: urn:placeOrder
[JMSWorker-1] DEBUG AddressEndpoint - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soapenv:Body&gt;
  &lt;m:placeOrder xmlns:m=&quot;http://services.samples/xsd&quot;&gt;&lt;m:order&gt;&lt;m:price&gt;12.33&lt;/m:price&gt;&lt;m:quantity&gt;1000&lt;/m:quantity&gt;&lt;m:symbol&gt;ACP&lt;/m:symbol&gt;&lt;/m:order&gt;
&lt;/m:placeOrder&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      The sample Axis2 server would now accept the one way message and issue the
      following message:
    </p>
<div><pre>Wed Apr 25 19:50:56 LKT 2007 samples.services.SimpleStockQuoteService :: Accepted order for : 1000 stocks of ACP at $ 12.33</pre></div>
    <p></p>
    <p>
      The next section of this example demonstrates how a pure binary JMS
      message could be received and processed through Synapse. The configuration
      creates a proxy service named 'JMSFileUploadProxy' that accepts binary
      messages and wraps them into a custom element
      '{http://services.samples/xsd}element'. The received message is then
      forwarded to the MTOMSwASampleService using the SOAP action
      'urn:oneWayUploadUsingMTOM' and optimizing binary conent using MTOM. To
      execute this sample, use the JMS client to publish a pure binary JMS
      message containing the file
      './../../repository/conf/sample/resources/mtom/asf-logo.gif' to the JMS
      destination 'dynamicQueues/JMSFileUploadProxy' as follows:
    </p>
<div><pre>ant jmsclient -Djms_type=binary -Djms_dest=dynamicQueues/JMSFileUploadProxy -Djms_payload=./../../repository/conf/sample/resources/mtom/asf-logo.gif</pre></div>
    <p>
      Examining the Synapse debug logs reveals that the binary content was
      received over JMS and wrapped with the specified element into a SOAP
      infoset as follows:
    </p>
<div><pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Proxy Service JMSFileUploadProxy received a new message...
...
[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
&lt;soapenv:Body&gt;&lt;axis2ns1:element xmlns:axis2ns1=&quot;http://services.samples/xsd&quot;&gt;R0lGODlhgw...AAOw==&lt;/axis2ns1:element&gt;&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      Thereafter the message was sent as a MTOM optimized message as specified
      by the 'format=mtom' attribute of the endpoint, to the
      MTOMSwASampleService using the SOAP action 'urn:oneWayUploadUsingMTOM'.
      Once received by the sample service, it is saved into a temporary file and
      could be verified for correctness.
    </p>
<div><pre>Wrote to file : /tmp/mtom-60319.gif</pre></div>
    <p></p>
    <p>
      The final section of this example shows how a POX JMS message received by
      Synapse is sent to the SimpleStockQuoteService as a SOAP message. Use the
      JMS client as follows to create a POX (Plain Old XML) message with a stock
      quote request payload (without a SOAP envelope), and send it to the JMS
      destination 'dynamicQueues/JMSPoxProxy' as follows:
    </p>
<div><pre>ant jmsclient -Djms_type=pox -Djms_dest=dynamicQueues/JMSPoxProxy -Djms_payload=MSFT</pre></div>
    <p>
      You can see that Synapse received the POX message and displays it as
      follows in the debug logs, and then converts it into a SOAP payload and
      sends to the SimpleStockQuoteService after setting the SOAP action as
      'urn:placeOrder'.
    </p>
    <p></p>
<div><pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Proxy Service JMSPoxProxy received a new message...
...
[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soapenv:Body&gt;&lt;m:placeOrder xmlns:m=&quot;http://services.samples/xsd&quot;&gt;
    &lt;m:order&gt;
        &lt;m:price&gt;172.39703010684752&lt;/m:price&gt;
        &lt;m:quantity&gt;19211&lt;/m:quantity&gt;
        &lt;m:symbol&gt;MSFT&lt;/m:symbol&gt;
    &lt;/m:order&gt;
&lt;/m:placeOrder&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;
[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Using the sequence named pox_proxy for message mediation
...
[JMSWorker-1] DEBUG HeaderMediator - Setting header : Action to : urn:placeOrder
...
[JMSWorker-1] DEBUG AddressEndpoint - Sending message to endpoint :: name = AnonymousEndpoints resolved address = http://localhost:9000/soap/SimpleStockQuoteService
[JMSWorker-1] DEBUG AddressEndpoint - SOAPAction: urn:placeOrder
[JMSWorker-1] DEBUG AddressEndpoint - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soapenv:Body&gt;&lt;m:placeOrder xmlns:m=&quot;http://services.samples/xsd&quot;&gt;
    &lt;m:order&gt;
        &lt;m:price&gt;172.39703010684752&lt;/m:price&gt;
        &lt;m:quantity&gt;19211&lt;/m:quantity&gt;
        &lt;m:symbol&gt;MSFT&lt;/m:symbol&gt;
    &lt;/m:order&gt;
&lt;/m:placeOrder&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;
[JMSWorker-1] DEBUG Axis2FlexibleMEPClient - sending [add = false] [sec = false] [rm = false] [ mtom = false] [ swa = false] [ force soap=true; pox=false] [ to null] </pre></div>
    <p>
      The sample Axis2 server displays a successful message on the receipt of
      the message as:
    </p>
<div><pre>Wed Apr 25 20:24:50 LKT 2007 samples.services.SimpleStockQuoteService :: Accepted order for : 19211 stocks of MSFT at $ 172.39703010684752</pre></div>
    <div class="section"><h2>
      <a name="Sample253" id="Sample253">Sample 253: One way bridging from
      JMS to http and replying with a 202 Accepted response</a>
    <a name="Sample_253:_One_way_bridging_from______JMS_to_http_and_replying_with_a_202_Accepted_response"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;proxy name=&quot;JMStoHTTPStockQuoteProxy&quot; transports=&quot;jms&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
            &lt;/inSequence&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;

    &lt;proxy name=&quot;OneWayProxy&quot; transports=&quot;http&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;log level=&quot;full&quot;/&gt;
                &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
                &lt;header name=&quot;To&quot; value=&quot;http://www.w3.org/2005/08/addressing/anonymous&quot;/&gt;
                &lt;property name=&quot;SC_ACCEPTED&quot; value=&quot;true&quot; scope=&quot;axis2&quot;/&gt;
                &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
                &lt;send/&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate one way message bridging from JMS to
      http and replying with a http 202 Accepted response</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> Start the Axis2 server
      and deploy the SimpleStockQuoteService if not already done
    </p>
    <p>
      Start the Synapse configuration numbered 253: i.e. synapse -sample 253
    </p>
    <p></p>
    <p>
      This example invokes the one-way 'placeOrder' operation on the
      SimpleStockQuoteService using the Axis2 ServiceClient.fireAndForget() API
      at the client. To test this, use 'ant -Dmode=placeorder...' and you will
      notice the one way JMS message flowing through Synapse into the sample
      Axis2 server instance over http, and Axis2 acknowledging it with a http
      202 Accepted response.
    </p>
<div><pre>ant stockquote -Dmode=placeorder -Dtrpurl=&quot;jms:/JMStoHTTPStockQuoteProxy?transport.jms.ConnectionFactoryJNDIName=QueueConnectionFactory&amp;java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory&amp;java.naming.provider.url=tcp://localhost:61616&quot;</pre></div>
<div><pre>SimpleStockQuoteService :: Accepted order for : 7482 stocks of IBM at $ 169.27205579038733</pre></div>
    <p>
      The second example shows how Synapse could be made to respond with a http
      202 Accepted response to a request received. The proxy service simply logs
      the message received and acknowledges it. On the Synapse console you could
      see the logged message, and if TCPMon was used at the client, you would
      see the 202 Accepted response sent back to the client from Synapse
    </p>
<div><pre>ant stockquote -Dmode=placeorder -Dtrpurl=http://localhost:8080/soap/OneWayProxy</pre></div>
<div><pre>HTTP/1.1 202 Accepted
Content-Type: text/xml; charset=UTF-8
Host: 127.0.0.1
SOAPAction: &quot;urn:placeOrder&quot;
Date: Sun, 06 May 2007 17:20:19 GMT
Server: Synapse-HttpComponents-NIO
Transfer-Encoding: chunked

0</pre></div>
    <div class="section"><h2>
      <a name="Sample254" id="Sample254">Sample 254: Using the file system as
      transport medium using VFS transport listener and sender</a>
    <a name="Sample_254:_Using_the_file_system_as______transport_medium_using_VFS_transport_listener_and_sender"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
        &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;vfs&quot;&gt;
                &lt;parameter name=&quot;transport.vfs.FileURI&quot;&gt;file:///home/user/test/in&lt;/parameter&gt; &lt;!--CHANGE--&gt;
                &lt;parameter name=&quot;transport.vfs.ContentType&quot;&gt;text/xml&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.vfs.FileNamePattern&quot;&gt;.*\.xml&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.PollInterval&quot;&gt;15&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.vfs.MoveAfterProcess&quot;&gt;file:///home/user/test/original&lt;/parameter&gt; &lt;!--CHANGE--&gt;
                &lt;parameter name=&quot;transport.vfs.MoveAfterFailure&quot;&gt;file:///home/user/test/original&lt;/parameter&gt; &lt;!--CHANGE--&gt;
                &lt;parameter name=&quot;transport.vfs.ActionAfterProcess&quot;&gt;MOVE&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.vfs.ActionAfterFailure&quot;&gt;MOVE&lt;/parameter&gt;

                &lt;target&gt;
                        &lt;endpoint&gt;
                                &lt;address format=&quot;soap12&quot; uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                        &lt;outSequence&gt;
                                &lt;property name=&quot;transport.vfs.ReplyFileName&quot;
                                          expression=&quot;fn:concat(fn:substring-after(get-property('MessageID'), 'urn:uuid:'), '.xml')&quot; scope=&quot;transport&quot;/&gt;
                                &lt;send&gt;
                                        &lt;endpoint&gt;
                                                &lt;address uri=&quot;vfs:file:///home/user/test/out&quot;/&gt; &lt;!--CHANGE--&gt;
                                        &lt;/endpoint&gt;
                                &lt;/send&gt;
                        &lt;/outSequence&gt;
                &lt;/target&gt;
                &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
        &lt;/proxy&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Using the file system as transport medium using VFS
      transport listener and sender</b>
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p>
      Create three new directories in a test directory. e.g. in, out, original
      in /home/user/test. Open
      SYNAPSE_HOME/repository/conf/sample/synapse_sample_115.xml and edit the
      following values. Change transport.vfs.FileURI,
      transport.vfs.MoveAfterProcess, transport.vfs.MoveAfterFailure parameter
      values to the above in, original, original directories respectively.
      Change outSequence endpoint address uri to out directory with the prefeix
      <i>vfs:</i>. Values you have to change are marked with &lt;!--CHANGE--&gt;.
    </p>
    <p>
      Start the Synapse configuration numbered 254: i.e. synapse -sample 254
    </p>
    <p>
      Copy SYNAPSE_HOME/repository/conf/sample/resources/vfs/test.xml to the
      directory given in transport.vfs.FileURI above.
    </p>
    <p>
      test.xml file content is as follows
    </p>
<div><pre>&lt;?xml version='1.0' encoding='UTF-8'?&gt;
        &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;&gt;
        &lt;soapenv:Body&gt;
                &lt;m0:getQuote xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                        &lt;m0:request&gt;
                                &lt;m0:symbol&gt;IBM&lt;/m0:symbol&gt;
                        &lt;/m0:request&gt;
                &lt;/m0:getQuote&gt;
        &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div>
    <p>
      VFS transport listener will pick the file from <i>in</i>
      directory and send it to the Axis2 service. The request XML file will be
      moved to <i>original</i> directory. The response from the Axis2
      server will be saved to <i>out</i> directory.
    </p>
    <div class="section"><h2>
      <a name="Sample255" id="Sample255">Sample 255: Switching from ftp
      transport listener to mail transport sender</a>
    <a name="Sample_255:_Switching_from_ftp______transport_listener_to_mail_transport_sender"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
        &lt;proxy name=&quot;StockQuoteProxy&quot; transports=&quot;vfs&quot;&gt;
                &lt;parameter name=&quot;transport.vfs.FileURI&quot;&gt;vfs:ftp://guest:guest@localhost/test?vfs.passive=true&lt;/parameter&gt; &lt;!--CHANGE--&gt;
                &lt;parameter name=&quot;transport.vfs.ContentType&quot;&gt;text/xml&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.vfs.FileNamePattern&quot;&gt;.*\.xml&lt;/parameter&gt;
                &lt;parameter name=&quot;transport.PollInterval&quot;&gt;15&lt;/parameter&gt;

                &lt;target&gt;
                        &lt;inSequence&gt;
                                &lt;header name=&quot;Action&quot; value=&quot;urn:getQuote&quot;/&gt;
                        &lt;/inSequence&gt;
                        &lt;endpoint&gt;
                                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                        &lt;outSequence&gt;
                                &lt;property action=&quot;set&quot; name=&quot;OUT_ONLY&quot; value=&quot;true&quot;/&gt;
                                &lt;send&gt;
                                        &lt;endpoint&gt;
                                                &lt;address uri=&quot;mailto:user@host&quot;/&gt; &lt;!--CHANGE--&gt;
                                        &lt;/endpoint&gt;
                                &lt;/send&gt;
                        &lt;/outSequence&gt;
                &lt;/target&gt;
                &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
        &lt;/proxy&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Switching from ftp transport listener to mail
      transport sender</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> You will need access to
      an FTP server and an SMTP server to try this sample.
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p>
      Enable mail transport sender in the Synapse axis2.xml. See <a href="Synapse_Samples_Setup.html#mailsender">Setting up mail transport
      sender</a>
    </p>
    <p>
      Create a new test directory in the FTP server. Open
      SYNAPSE_HOME/repository/conf/sample/synapse_sample_116.xml and edit the
      following values. Change transport.vfs.FileURI parameter value point to
      the test directory at the FTP server. Change outSequence endpoint address
      uri email address to a working email address. Values you have to change
      are marked with &lt;!--CHANGE--&gt;.
    </p>
    <p>
      Start the Synapse configuration numbered 255: i.e. synapse -sample 255
    </p>
    <p>
      Copy SYNAPSE_HOME/repository/conf/sample/resources/vfs/test.xml to the ftp
      directory given in transport.vfs.FileURI above.
    </p>
    <p>
      VFS transport listener will pick the file from the directory in the ftp
      server and send it to the Axis2 service. The file in the ftp directory
      will be deleted. The response will be sent to the given email address.
    </p>
    <h1>
      <a name="Task" id="Task">Introduction to synapse tasks</a>
    </h1>
    <div class="section"><h2>
      <a name="Sample300" id="Sample300">Sample 300: Introduction to tasks
      with simple trigger</a>
    <a name="Sample_300:_Introduction_to_tasks______with_simple_trigger"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;task class=&quot;org.apache.synapse.startup.tasks.MessageInjector&quot; name=&quot;CheckPrice&quot;&gt;
        &lt;property name=&quot;to&quot; value=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
        &lt;property name=&quot;soapAction&quot; value=&quot;urn:getQuote&quot;/&gt;
        &lt;property name=&quot;message&quot;&gt;
            &lt;m0:getQuote xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                &lt;m0:request&gt;
                    &lt;m0:symbol&gt;IBM&lt;/m0:symbol&gt;
                &lt;/m0:request&gt;
            &lt;/m0:getQuote&gt;
        &lt;/property&gt;
        &lt;trigger interval=&quot;5000&quot;/&gt;
    &lt;/task&gt;

    &lt;in&gt;
        &lt;send/&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;Stock Quote on&quot; expression=&quot;//ns:return/ns:lastTradeTimestamp/child::text()&quot; xmlns:ns=&quot;http://services.samples/xsd&quot;/&gt;
            &lt;property name=&quot;For the organization&quot; expression=&quot;//ns:return/ns:name/child::text()&quot; xmlns:ns=&quot;http://services.samples/xsd&quot;/&gt;
            &lt;property name=&quot;Last Value&quot; expression=&quot;//ns:return/ns:last/child::text()&quot; xmlns:ns=&quot;http://services.samples/xsd&quot;/&gt;
        &lt;/log&gt;
    &lt;/out&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Introduce the concept of tasks and how simple
      trigger works</b>
    </p>
    <p>
      <b>Prerequisites:</b><br /> You will need access to
      build the SimpleStockQuoteService as mentioned in the above and start the
      sample axis2 server before staring synapse.
    </p>
    <p>
      When ever synapse gets started and initialized, this task will run
      periodically in 5 second intervals. You could limit the number of times
      that you want to run this task by adding a count attribute with an integer
      as the value, if the count is not present as in this sample this task will
      run forever.
    </p>
    <p>
      One can write his own task class implementing the
      org.apache.synapse.startup.Task interface and implementing the execute
      method to do the task. For this particular sample we have used the
      MessageInjector which just injects a message specified in to the synapse
      environment.
    </p>
    <h1>
      <a name="AdvancedMediation" id="AdvancedMediation">Advanced mediations
      with advanced mediators</a>
    </h1>
    <div class="section"><h2>
      <a name="ScriptMediator" id="ScriptMediator">Using scripts in mediation
      (Script Mediator)</a>
    <a name="Using_scripts_in_mediation______Script_Mediator"></a></h2>
    <p>
      The Synapse Script Mediator is a Synapse extension, and thus all
      prerequisites are not bundled by default with the Synapse distribution.
      Before you use some script mediators you may need to manually add the
      required jar files to the Synapse lib directory, and optionally perform
      other installation tasks as may be required by the individual scripting
      language. This is explained in the <a href="Synapse_Samples_Setup.html#script">Samples Setup guide</a>.
    </p>
    <div class="section"><h2>
      <a name="Sample350" id="Sample350">Sample 350: Introduction to the
      script mediator using js scripts</a>
    <a name="Sample_350:_Introduction_to_the______script_mediator_using_js_scripts"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;localEntry key=&quot;stockquoteScript&quot; src=&quot;file:repository/conf/sample/resources/script/stockquoteTransform.js&quot;/&gt;

    &lt;in&gt;
        &lt;!-- transform the custom quote request into a standard quote request expected by the service --&gt;
        &lt;script language=&quot;js&quot; key=&quot;stockquoteScript&quot; function=&quot;transformRequest&quot;/&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;!-- transform the standard response back into the custom format the client expects --&gt;
        &lt;script language=&quot;js&quot; key=&quot;stockquoteScript&quot; function=&quot;transformResponse&quot;/&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt; </pre></div>
    <p></p>
<div><pre>&lt;x&gt;&lt;![CDATA[
  function transformRequest(mc) {
     var symbol = mc.getPayloadXML()..*::Code.toString();
     mc.setPayloadXML(
        &lt;m:getQuote xmlns:m=&quot;http://services.samples/xsd&quot;&gt;
           &lt;m:request&gt;
              &lt;m:symbol&gt;{symbol}&lt;/m:symbol&gt;
           &lt;/m:request&gt;
        &lt;/m:getQuote&gt;);
  }

  function transformResponse(mc) {
     var symbol = mc.getPayloadXML()..*::symbol.toString();
     var price = mc.getPayloadXML()..*::last.toString();
     mc.setPayloadXML(
        &lt;m:CheckPriceResponse xmlns:m=&quot;http://www.apache-synapse.org/test&quot;&gt;
   &lt;m:Code&gt;{symbol}&lt;/m:Code&gt;
   &lt;m:Price&gt;{price}&lt;/m:Price&gt;
        &lt;/m:CheckPriceResponse&gt;);
  }
]]&gt;&lt;/x&gt;</pre></div>
    <p>
      <b>Objective: Introduction to script mediators</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start the Synapse configuration numbered 350: i.e. synapse -sample 350<br />
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      This sample is similar to sample 8 but instead of using XSLT the
      transformation is done with JavaScript and E4X. Note that the script
      source loaded from a resource must be specified within a CDATA tag within
      an XML element. The script used in this example has two functions,
      'transformRequest' and 'transformResponse', and the Synapse configuration
      uses the function attribute to specify which function should be invoked.
      Use the stock quote client to issue a custom quote client as follows.:
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dmode=customquote</pre></div>
    <p>
      Synapse uses the script mediator and the specified Javascript function to
      convert the custom request to a standard quote request. Subsequently the
      response received is transformed and sent back to the client.
    </p>
    <div class="section"><h2>
      <a name="Sample351" id="Sample351">Sample 351: In-line script mediation
      with JavaScript</a>
    <a name="Sample_351:_In-line_script_mediation______with_JavaScript"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;in&gt;
        &lt;!-- transform the custom quote request into a standard quote requst expected by the service --&gt;
        &lt;script language=&quot;js&quot;&gt;&lt;![CDATA[
               var symbol = mc.getPayloadXML()..*::Code.toString();
               mc.setPayloadXML(
                  &lt;m:getQuote xmlns:m=&quot;http://services.samples/xsd&quot;&gt;
                     &lt;m:request&gt;
                        &lt;m:symbol&gt;{symbol}&lt;/m:symbol&gt;
                     &lt;/m:request&gt;
                  &lt;/m:getQuote&gt;);
        ]]&gt;&lt;/script&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;!-- transform the standard response back into the custom format the client expects --&gt;
        &lt;script language=&quot;js&quot;&gt;&lt;![CDATA[
               var symbol = mc.getPayloadXML()..*::symbol.toString();
               var price = mc.getPayloadXML()..*::last.toString();
               mc.setPayloadXML(
                  &lt;m:CheckPriceResponse xmlns:m=&quot;http://www.apache-synapse.org/test&quot;&gt;
               &lt;m:Code&gt;{symbol}&lt;/m:Code&gt;
               &lt;m:Price&gt;{price}&lt;/m:Price&gt;
                  &lt;/m:CheckPriceResponse&gt;);
            ]]&gt;&lt;/script&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Introduction to in-line script mediation</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start the Synapse configuration numbered 351: i.e. synapse -sample 351<br />
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      This example is functionally equivalent to sample # 350 and sample # 8,
      and demonstrates in-line script mediation in Synapse. Use the stock quote
      client to send a custom quote as in example # 500 to test this example.
    </p>
    <p></p>
    <div class="section"><h2>
      <a name="Sample352" id="Sample352">Sample 352: Accessing Synapse
      message context API methods using scripting language</a>
    <a name="Sample_352:_Accessing_Synapse______message_context_API_methods_using_scripting_language"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;in&gt;
       &lt;!-- change the MessageContext into a response and set a response payload --&gt;
       &lt;script language=&quot;js&quot;&gt;&lt;![CDATA[
          mc.setTo(mc.getReplyTo());
          mc.setProperty(&quot;RESPONSE&quot;, &quot;true&quot;);
          mc.setPayloadXML(
             &lt;ns:getQuoteResponse xmlns:ns=&quot;http://services.samples/xsd&quot;&gt;
                &lt;ns:return&gt;
                   &lt;ns:last&gt;99.9&lt;/ns:last&gt;
                &lt;/ns:return&gt;
             &lt;/ns:getQuoteResponse&gt;);
       ]]&gt;&lt;/script&gt;
    &lt;/in&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre></div>
    <p>
      <b>Objective: Accessing the Synapse APIs from scripting languages</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Start the Synapse configuration numbered 352: i.e. bin/synapse -sample 352<br />
    </p>
    <p></p>
    <p>
      This example shows how an inline JavaScript mediator script could access
      the Synapse message context API to set its 'To' EPR and to set a custom
      property to mark it as a response. Execute the stock quote client, and you
      will receive the response &quot;99.9&quot; as the last sale price as per the above
      script.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/
...
stockquote:
     [java] Standard :: Stock price = $99.9</pre></div>
    <div class="section"><h2>
      <a name="Sample353" id="Sample353">Sample 353: Using Ruby scripts for
      mediation</a>
    <a name="Sample_353:_Using_Ruby_scripts_for______mediation"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;localEntry key=&quot;stockquoteScript&quot; src=&quot;file:repository/conf/sample/resources/script/stockquoteTransform.rb&quot;/&gt;
    &lt;in&gt;
        &lt;!-- transform the custom quote request into a standard quote request expected by the service --&gt;
        &lt;script language=&quot;rb&quot; key=&quot;stockquoteScript&quot; function=&quot;transformRequest&quot;/&gt;

        &lt;!-- send message to real endpoint referenced by name &quot;stockquote&quot; and stop --&gt;
        &lt;send&gt;
            &lt;endpoint name=&quot;stockquote&quot;&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;!-- transform the standard response back into the custom format the client expects --&gt;
        &lt;script language=&quot;rb&quot; key=&quot;stockquoteScript&quot; function=&quot;transformResponse&quot;/&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt; </pre></div>
<div><pre>&lt;x&gt;&lt;![CDATA[
require 'rexml/document'
include REXML

def transformRequest(mc)
   newRequest= Document.new '&lt;m:getQuote xmlns:m=&quot;http://services.samples/xsd&quot;&gt;'&lt;&lt;
      '&lt;m:request&gt;&lt;m:symbol&gt;&lt;/m:symbol&gt;&lt;/m:request&gt;&lt;/m:getQuote&gt;'
   newRequest.root.elements[1].elements[1].text = mc.getPayloadXML().root.elements[1].get_text
   mc.setPayloadXML(newRequest)
end

def transformResponse(mc)
   newResponse = Document.new '&lt;m:CheckPriceResponse xmlns:m=&quot;http://www.apache-synapse.org/test&quot;&gt;&lt;m:Code&gt;' &lt;&lt;
      '&lt;/m:Code&gt;&lt;m:Price&gt;&lt;/m:Price&gt;&lt;/m:CheckPriceResponse&gt;'
   newResponse.root.elements[1].text = mc.getPayloadXML().root.elements[1].elements[1].get_text
   newResponse.root.elements[2].text = mc.getPayloadXML().root.elements[1].elements[2].get_text
   mc.setPayloadXML(newResponse)
end
]]&gt;&lt;/x&gt;</pre></div>
    <p>
      <b>Objective: Script mediators using Ruby</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      This sample uses Ruby so first setup support for this in Synapse as
      described at <a href="Synapse_Samples_Setup.html#script">Configuring
      JRuby</a>.
    </p>
    <p>
      Start the Synapse configuration numbered 353: i.e. bin/synapse -sample 353<br />
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      This sample is functionally equivalent to sample # 500 (#501 and #8) but
      instead uses a Ruby script using the JRuby interpreter. The script has two
      functions, 'transformRequest' and 'transformResponse', and the Synapse
      configuration specifies which function is to be invoked when used. Execute
      the stock quote client to send a custom stock quote as per example #500
      and check the received stock quote response.
    </p>
    <div class="section"><h2>
      <a name="DBMediators" id="DBMediators">Database interactions in
      mediation (DBLookup / DBReport)</a>
    <a name="Database_interactions_in______mediation_DBLookup__DBReport"></a></h2>
    <p>
      Following database mediators use Derby in a client/server configuration by
      using the network server. Therefore, to proceed with the following
      samples, you need a working Derby database server and you have to follow
      the steps in <a href="Synapse_Samples_Setup.html#derby">Sample Setup
      Guide</a> before going through the samples.
    </p>
    <p></p>
    <div class="section"><h2>
      <a name="Sample360" id="Sample360">Sample 360: Introduction to dblookp
      mediator</a>
    <a name="Sample_360:_Introduction_to_dblookp______mediator"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;myFaultHandler&quot;&gt;
        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason expression=&quot;get-property('ERROR_MESSAGE')&quot;/&gt;
        &lt;/makefault&gt;

        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
        &lt;header name=&quot;To&quot; expression=&quot;get-property('ReplyTo')&quot;/&gt;
        &lt;send/&gt;
        &lt;drop/&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;myFaultHandler&quot;&gt;
        &lt;in&gt;
            &lt;log level=&quot;custom&quot;&gt;
                &lt;property name=&quot;text&quot;
                          value=&quot;** Looking up from the Database **&quot;/&gt;
            &lt;/log&gt;
            &lt;dblookup xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
                &lt;connection&gt;
                    &lt;pool&gt;
                        &lt;driver&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver&gt;
                        &lt;url&gt;jdbc:derby://localhost:1527/synapsedb;create=false&lt;/url&gt;
                        &lt;user&gt;synapse&lt;/user&gt;
                        &lt;password&gt;synapse&lt;/password&gt;
                    &lt;/pool&gt;
                &lt;/connection&gt;
                &lt;statement&gt;
                    &lt;sql&gt;select * from company where name =?&lt;/sql&gt;
                    &lt;parameter expression=&quot;//m0:getQuote/m0:request/m0:symbol&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;VARCHAR&quot;/&gt;
                    &lt;result name=&quot;company_id&quot; column=&quot;id&quot;/&gt;
                &lt;/statement&gt;
            &lt;/dblookup&gt;

            &lt;switch source=&quot;get-property('company_id')&quot;&gt;
                &lt;case regex=&quot;c1&quot;&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot;
                                  expression=&quot;fn:concat('Company ID - ',get-property('company_id'))&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex=&quot;c2&quot;&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot;
                                  expression=&quot;fn:concat('Company ID - ',get-property('company_id'))&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex=&quot;c3&quot;&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot;
                                  expression=&quot;fn:concat('Company ID - ',get-property('company_id'))&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;default&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;** Unrecognized Company ID **&quot;/&gt;
                    &lt;/log&gt;
                    &lt;makefault&gt;
                        &lt;code value=&quot;tns:Receiver&quot;
                              xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
                        &lt;reason value=&quot;** Unrecognized Company ID **&quot;/&gt;
                    &lt;/makefault&gt;
                    &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
                    &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
                    &lt;send/&gt;
                    &lt;drop/&gt;
                &lt;/default&gt;
            &lt;/switch&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;

    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p></p>
    <p></p>
    <p>
      <b>Objective:</b> I<b>ntroduction to the
      dblookup mediator</b>
    </p>
    <p>
      <b>Prerequisites:</b> Setting up Derby database as
      explained above.
    </p>
    <p>
      Start the Synapse configuration numbered 360: i.e. synapse -sample 360
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      This sample demonstrates simple database read operations through Synapse.
      When a message arrives at dblookup mediator, it opens a connection to the
      database and executes the SQL query. The SQL query use '?' character for
      attributes that will be filled at runtime. The parameters define how to
      calculate the value of those attributes at runtime. In this sample a
      dblookup mediator has been used to extract 'id' of the company from the
      company database using the symbol which is evaluated using an xpath
      against the SOAP envelope. Then 'id' base switching will be done by a
      switch mediator.
    </p>
    <p></p>
    <p>
      When the IBM stock quote is requested,
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=IBM</pre></div>
    <p>
      Synapse console shows
    </p>
<div><pre>INFO LogMediator text = ** Looking up from the Database **INFO LogMediator text = Company ID &#x2013; c1</pre></div>
    <p></p>
    <p>
      For the SUN stock quote,
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=SUN</pre></div>
    <p></p>
    <p>
      Synapse console shows
    </p>
<div><pre>INFO LogMediator text = ** Looking up from the Database **INFO LogMediator text = Company ID &#x2013; c2</pre></div>
    <p>
      and for the MSFT stock quote,
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</pre></div>
<div><pre>INFO LogMediator text = ** Looking up from the Database **INFO LogMediator text = Company ID &#x2013; c2</pre></div>
    <p>
      For any other symbols, Synapse console shows
    </p>
<div><pre>INFO LogMediator text = ** Unrecognized Company ID **</pre></div>
    <p></p>
    <p>
      and the client gets a response which has following message.
    </p>
<div><pre>** Unrecognized Company ID **</pre></div>
    <div>
    </div>
    <div class="section"><h2>
      <a name="Sample361" id="Sample361">Sample 361: Introduction to dbreport
      mediator</a>
    <a name="Sample_361:_Introduction_to_dbreport______mediator"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;log level=&quot;custom&quot;&gt;
                &lt;property name=&quot;text&quot;
                          value=&quot;** Reporting to the Database **&quot;/&gt;
            &lt;/log&gt;
            &lt;dbreport xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
                &lt;connection&gt;
                    &lt;pool&gt;
                        &lt;driver&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver&gt;
                        &lt;url&gt;jdbc:derby://localhost:1527/synapsedb;create=false&lt;/url&gt;
                        &lt;user&gt;synapse&lt;/user&gt;
                        &lt;password&gt;synapse&lt;/password&gt;
                    &lt;/pool&gt;
                &lt;/connection&gt;
                &lt;statement&gt;
                    &lt;sql&gt;update company set price=? where name =?&lt;/sql&gt;
                    &lt;parameter expression=&quot;//m0:return/m0:last/child::text()&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;DOUBLE&quot;/&gt;
                    &lt;parameter expression=&quot;//m0:return/m0:symbol/child::text()&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;VARCHAR&quot;/&gt;
                &lt;/statement&gt;
            &lt;/dbreport&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <div>
      <p>
        <b>Objective: I<b>ntroduction to the dbreport mediator</b></b>
      </p>
      <p>
        <b>Prerequisites:</b> Setting up Derby database as
        above.
      </p>
      <p>
        Start the Synapse configuration numbered 361: i.e. synapse -sample 361
      </p>
      <p>
        Start the Axis2 server and deploy the SimpleStockQuoteService if not
        already done
      </p>
    </div>
    <p>
      This sample demonstrate simple database write operations. The dbreport
      mediator writes (i.e. inserts one row) to a table using the message
      details. It works the same as the dblookup mediator. In this sample ,
      dbreport mediator is used for updating the stock price of the company
      using the last quote value which is calculated by evaluating an XPath
      against the response message. After running this sample, user can check
      the company table using the Derby client tool. It will show the inserted
      value by the dbreport mediator.
    </p>
    <p></p>
    <p>
      Run the client using,
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=IBM</pre></div>
    <p>
      and then execute the following query using database client tool against
      synapsedb.
    </p>
<div><pre>select price from company where name='IBM';</pre></div>
    <p>
      It will show some value as follows.
    </p>
<div><pre>96.39535981018865</pre></div>
    <div>
    </div>
    <div class="section"><h2>
      <a name="Sample362" id="Sample362">Sample 362: Action of dbreport and
      dblookup mediators together</a>
    <a name="Sample_362:_Action_of_dbreport_and______dblookup_mediators_together"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint&gt;
                    &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;log level=&quot;custom&quot;&gt;
                &lt;property name=&quot;text&quot;
                          value=&quot;** Reporting to the Database **&quot;/&gt;
            &lt;/log&gt;

            &lt;dbreport xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
                &lt;connection&gt;
                    &lt;pool&gt;
                        &lt;driver&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver&gt;
                        &lt;url&gt;jdbc:derby://localhost:1527/synapsedb;create=false&lt;/url&gt;
                        &lt;user&gt;synapse&lt;/user&gt;
                        &lt;password&gt;synapse&lt;/password&gt;
                    &lt;/pool&gt;
                &lt;/connection&gt;
                &lt;statement&gt;
                    &lt;sql&gt;update company set price=? where name =?&lt;/sql&gt;
                    &lt;parameter expression=&quot;//m0:return/m0:last/child::text()&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;DOUBLE&quot;/&gt;
                    &lt;parameter expression=&quot;//m0:return/m0:symbol/child::text()&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;VARCHAR&quot;/&gt;
                &lt;/statement&gt;
            &lt;/dbreport&gt;
            &lt;log level=&quot;custom&quot;&gt;
                &lt;property name=&quot;text&quot;
                          value=&quot;** Looking up from the Database **&quot;/&gt;
            &lt;/log&gt;
            &lt;dblookup xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
                &lt;connection&gt;
                    &lt;pool&gt;
                        &lt;driver&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver&gt;
                        &lt;url&gt;jdbc:derby://localhost:1527/synapsedb;create=false&lt;/url&gt;
                        &lt;user&gt;synapse&lt;/user&gt;
                        &lt;password&gt;synapse&lt;/password&gt;
                    &lt;/pool&gt;
                &lt;/connection&gt;
                &lt;statement&gt;
                    &lt;sql&gt;select * from company where name =?&lt;/sql&gt;
                    &lt;parameter expression=&quot;//m0:return/m0:symbol/child::text()&quot;
                               xmlns:m0=&quot;http://services.samples/xsd&quot; type=&quot;VARCHAR&quot;/&gt;
                    &lt;result name=&quot;stock_price&quot; column=&quot;price&quot;/&gt;
                &lt;/statement&gt;
            &lt;/dblookup&gt;
            &lt;log level=&quot;custom&quot;&gt;
                &lt;property name=&quot;text&quot;
                          expression=&quot;fn:concat('Stock price - ',get-property('stock_price'))&quot;/&gt;
            &lt;/log&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the use of dbreport and dblookup
      mediators</b>
    </p>
    <p>
      <b>Prerequisites:</b> Setting up Derby database as
      above.
    </p>
    <p>
      Start the Synapse configuration numbered 362: i.e. synapse -sample 362
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done
    </p>
    <p></p>
    <p>
      In this sample ,the dbreport mediator works the same as the above sample.
      It updates the price for the given company using the response messages
      content. Then the dblookup mediator reads the last updated value from the
      company database and logs it.
    </p>
    <p>
      When running client,
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=IBM</pre></div>
    <p>
      Synapse console shows,
    </p>
<div><pre>INFO LogMediator text = ** Reporting to the Database **...INFO LogMediator text = ** Looking up from the Database **...INFO LogMediator text = Stock price - 153.47886496064808</pre></div>
    <p></p>
    <div class="section"><h2>
      <a name="Throttle" id="Throttle">Throtteling messages (Throttle
      Mediator)</a>
    <a name="Throtteling_messages_Throttle______Mediator"></a></h2>

    <div class="section"><h2>
      <a name="Sample370" id="Sample370">Sample 370: Introduction to throttle
      mediator and concurrency throttling</a>
    <a name="Sample_370:_Introduction_to_throttle______mediator_and_concurrency_throttling"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;throttle id=&quot;A&quot;&gt;
                &lt;policy&gt;
                    &lt;!-- define throttle policy --&gt;
                    &lt;wsp:Policy xmlns:wsp=&quot;http://schemas.xmlsoap.org/ws/2004/09/policy&quot;
                                xmlns:throttle=&quot;http://www.wso2.org/products/wso2commons/throttle&quot;&gt;
                        &lt;throttle:ThrottleAssertion&gt;
                            &lt;throttle:MaximumConcurrentAccess&gt;10&lt;/throttle:MaximumConcurrentAccess&gt;
                        &lt;/throttle:ThrottleAssertion&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/policy&gt;
                &lt;onAccept&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Accept**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/onAccept&gt;
                &lt;onReject&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;makefault&gt;
                        &lt;code value=&quot;tns:Receiver&quot;
                              xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
                        &lt;reason value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/makefault&gt;
                    &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
                    &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
                    &lt;send/&gt;
                    &lt;drop/&gt;
                &lt;/onReject&gt;
            &lt;/throttle&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;throttle id=&quot;A&quot;/&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the use of throttle mediator for concurrency
      throttling </b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Deploy the SimpleStockQuoteService in sample Axis2 server and start it on
      port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 370 (i.e. synapse -sample
      370).
    </p>
    <p></p>
    <p>
      Above configuration specifies a throttle mediator inside the in mediator.
      Therefore, all request messages directed to the main sequence will be
      subjected to throttling. Throttle mediator has policy, onAccept and
      onReject tags at top level. Policy tag specifies the throttling policy to
      be applied for messages. In this sample policy contains only component
      called &quot;MaximumConcurrentAccess&quot; .This indicates the maximum number of
      concurrent request that may have passed through the synapse on a single
      unit of time. To test concurrency throttling ,it is required to send
      concurrent request to synapse. For synapse with above configuration ,if
      client send 20 request concurrently ,then approximately half of those will
      success. The client command is as follows.
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080/</pre></div>
    <p></p>
    <div class="section"><h2>
      <a name="Sample371" id="Sample371">Sample 371: Restricting requests
      based on policies </a>
    <a name="Sample_371:_Restricting_requests______based_on_policies"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;sequence name=&quot;main&quot;&gt;
        &lt;in&gt;
            &lt;throttle id=&quot;A&quot;&gt;
                &lt;policy&gt;
                    &lt;!-- define throttle policy --&gt;
                    &lt;wsp:Policy xmlns:wsp=&quot;http://schemas.xmlsoap.org/ws/2004/09/policy&quot;
                                xmlns:throttle=&quot;http://www.wso2.org/products/wso2commons/throttle&quot;&gt;
                        &lt;throttle:ThrottleAssertion&gt;                                      &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;Other&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;4&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;800000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;10000&lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.200-192.168.8.222&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;8&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;800000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;10&lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.201&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;200&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;600000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;&lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                            &lt;wsp:All&gt;
                                &lt;throttle:ID throttle:type=&quot;IP&quot;&gt;192.168.8.198&lt;/throttle:ID&gt;
                                &lt;wsp:ExactlyOne&gt;
                                    &lt;wsp:All&gt;
                                        &lt;throttle:MaximumCount&gt;50&lt;/throttle:MaximumCount&gt;
                                        &lt;throttle:UnitTime&gt;500000&lt;/throttle:UnitTime&gt;
                                        &lt;throttle:ProhibitTimePeriod wsp:Optional=&quot;true&quot;&gt;&lt;/throttle:ProhibitTimePeriod&gt;
                                    &lt;/wsp:All&gt;
                                    &lt;throttle:IsAllow&gt;true&lt;/throttle:IsAllow&gt;
                                &lt;/wsp:ExactlyOne&gt;
                            &lt;/wsp:All&gt;
                        &lt;/throttle:ThrottleAssertion&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/policy&gt;
                &lt;onAccept&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Accept**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;
                            &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                        &lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/onAccept&gt;
                &lt;onReject&gt;
                    &lt;log level=&quot;custom&quot;&gt;
                        &lt;property name=&quot;text&quot; value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/log&gt;
                    &lt;makefault&gt;
                        &lt;code value=&quot;tns:Receiver&quot;
                              xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
                        &lt;reason value=&quot;**Access Denied**&quot;/&gt;
                    &lt;/makefault&gt;
                    &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
                    &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
                    &lt;send/&gt;
                    &lt;drop/&gt;
                &lt;/onReject&gt;
            &lt;/throttle&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;throttle id=&quot;A&quot;/&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b>Objective: Demonstrate the use of throttle mediator for
      restricting request counts</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Deploy the SimpleStockQuoteService in sample Axis2 server and start it on
      port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 371 (i.e. synapse -sample
      371).
    </p>
    <p></p>
    <p>
      Above configuration specifies a throttle mediator inside the in mediator.
      Therefore, all request messages directed to the main sequence will be
      subjected to throttling. Throttle mediator has policy, onAccept and
      onReject tags at the top level. Policy tag specifies the throttling policy
      to be applied for messages. It contains some IP address ranges and the
      maximum number of messages to be allowed for those ranges within a time
      period given in &quot;UnitTime&quot; tag. &quot;ProhibitTimePeriod&quot; tag specifies the
      time period to prohibit further requests after the received request count
      exceeds the specified time. Now run the client 5 times repetitively using
      the following command to see how throttling works.
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080/</pre></div>
    <p>
      For the first four requests you will get the quote prices for IBM as
      follows.
    </p>
<div><pre>[java] Standard :: Stock price = $177.20143371883802</pre></div>
    <p>
      You will receive the following response for the fifth request.
    </p>
<div><pre>[java] org.apache.axis2.AxisFault: **Access Denied**</pre></div>
    <p>
      Maximum number of requests within 800000 milliseconds is specified as 4
      for any server (including localhost) other than the explicitly specified
      ones. Therefore, our fifth request is denied by the throttle mediator. You
      can verify this by looking at the Synapse console.
    </p>
<div><pre>[HttpServerWorker-1] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-2] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-3] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-4] INFO  LogMediator - text = **Access Accept**
[HttpServerWorker-5] INFO  LogMediator - text = **Access Denied** </pre></div>
    <div class="section"><h2>
      <a name="Sample372" id="Sample372">Sample 372: Use of both concurrency
      throttling and request rate based throttling </a>
    <a name="Sample_372:_Use_of_both_concurrency______throttling_and_request_rate_based_throttling"></a></h2>
<div><pre>&lt;!-- Use of both concurrency throttling and request rate based throttling --&gt;
&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:repository/&lt;/parameter&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;150000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;sequence name=&quot;onAcceptSequence&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;text&quot; value=&quot;**Access Accept**&quot;/&gt;
        &lt;/log&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;
    &lt;sequence name=&quot;onRejectSequence&quot; trace=&quot;enable&quot;&gt;
        &lt;log level=&quot;custom&quot;&gt;
            &lt;property name=&quot;text&quot; value=&quot;**Access Denied**&quot;/&gt;
        &lt;/log&gt;
        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot;
                  xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;**Access Denied**&quot;/&gt;
        &lt;/makefault&gt;
        &lt;property name=&quot;RESPONSE&quot; value=&quot;true&quot;/&gt;
        &lt;header name=&quot;To&quot; action=&quot;remove&quot;/&gt;
        &lt;send/&gt;
        &lt;drop/&gt;
    &lt;/sequence&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
             &lt;inSequence&gt;
                &lt;throttle onReject=&quot;onRejectSequence&quot; onAccept=&quot;onAcceptSequence&quot; id=&quot;A&quot;&gt;
                    &lt;policy key=&quot;conf/sample/resources/policy/throttle_policy.xml&quot;/&gt;
                &lt;/throttle&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;throttle id=&quot;A&quot;/&gt;
                &lt;send/&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <div>
    </div>
    <p>
      <b>Objective: Use of both concurrency throttling and request rate
      based throttling </b>
    </p>
    <p>
      <b>Prerequisites:</b> Deploy the
      SimpleStockQuoteService in sample Axis2 server and start it on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 372 (i.e. synapse -sample
      372).
    </p>
    <p></p>
    <p>
      Throttle policy is loaded from the &#x201c;throttle_policy. xml&#x201d;
      .That policy contains merging policy from sample 370 and 371. To check the
      functionality , it is need to run load test.The all enabled request from
      the concurrency throttling will be controlled by the access rate base
      throttling according to the policy.
    </p>
    <p>
      Run the client as follows
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy</pre></div>
    <div>
      <p>
        You will get results same as sample 371.if you run the load test,
        results will be different due to affect of concurrency throttling.
      </p>
    </div>
    <div class="section"><h2>
      <a name="Class" id="Class">Extending the mediation in java (Class
      Mediator)</a>
    <a name="Extending_the_mediation_in_java_Class______Mediator"></a></h2>
    <p>
      Class mediator can be used to write your own custom mediation in Java and
      you have access to the SynapseMessageContext and all the Synapse API in
      there. This is a useful extension mechanism within Synapse to extend its
      functionality. This class can contain fields for which you can assign
      values at runtime through the configuration.
    </p>
    <div class="section"><h2>
      <a name="Sample380" id="Sample380">Sample 380: Writing your own custom
      mediation in Java</a>
    <a name="Sample_380:_Writing_your_own_custom______mediation_in_Java"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;sequence name=&quot;fault&quot;&gt;
        &lt;makefault&gt;
            &lt;code value=&quot;tns:Receiver&quot; xmlns:tns=&quot;http://www.w3.org/2003/05/soap-envelope&quot;/&gt;
            &lt;reason value=&quot;Mediation failed.&quot;/&gt;
        &lt;/makefault&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;

    &lt;sequence name=&quot;main&quot; onError=&quot;fault&quot;&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint name=&quot;stockquote&quot;&gt;
                    &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                &lt;/endpoint&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;class name=&quot;samples.mediators.DiscountQuoteMediator&quot;&gt;
                &lt;property name=&quot;discountFactor&quot; value=&quot;10&quot;/&gt;
                &lt;property name=&quot;bonusFor&quot; value=&quot;5&quot;/&gt;
            &lt;/class&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre></div>
    <p></p>
    <p>
      <b>Objective: Demonstrate the use of Class mediator to extend the
      mediation functionality</b>
    </p>
    <p>
      <b>Prerequisites:</b>
    </p>
    <p>
      Make sure the synapse-samples-1.0.jar is in your class path (by default
      this jar is placed in the lib directory when installing Synapse).
    </p>
    <p>
      Start Synapse with the sample configuration 380 (i.e. synapse -sample 380)
    </p>
    <p>
      Start the sample Axis2 server and deploy the SimpleStockQuoteService.
    </p>
    <p></p>
    <p>
      In this configuration, Synapse hands over the request message to the
      specified endpoint, which sends it to the Axis2 server running on port
      9000.
    </p>
    <p>
      But the response message is passed through the class mediator before
      sending it back to the client. Two parameters named &quot;discountFactor&quot;
    </p>
    <p>
      and &quot;bonusFor&quot; are passed to the instance mediator implementation class
      (i.e. samples.mediators.DiscountQuoteMediator) before each
    </p>
    <p>
      invocation. Code of the mediator implementation class is shown below.
    </p>
<div><pre>package samples.mediators;

import org.apache.synapse.MessageContext;
import org.apache.synapse.Mediator;
import org.apache.axiom.om.OMElement;
import org.apache.axiom.om.OMAbstractFactory;
import org.apache.axiom.om.OMFactory;
import org.apache.axiom.soap.SOAPFactory;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import javax.xml.namespace.QName;

public class DiscountQuoteMediator implements Mediator {

    private static final Log log = LogFactory.getLog(DiscountQuoteMediator.class);

    private String discountFactor=&quot;10&quot;;

    private String bonusFor=&quot;10&quot;;

    private int bonusCount=0;

    public DiscountQuoteMediator(){}

    public boolean mediate(MessageContext mc) {

        String price= mc.getEnvelope().getBody().getFirstElement().getFirstElement().
                getFirstChildWithName(new QName(&quot;http://services.samples/xsd&quot;,&quot;last&quot;)).getText();

        //converting String properties into integers
        int discount=Integer.parseInt(discountFactor);
        int bonusNo=Integer.parseInt(bonusFor);
        double currentPrice=Double.parseDouble(price);

        //discounting factor is deducted from current price form every response
        Double lastPrice = new Double(currentPrice - currentPrice * discount / 100);

        //Special discount of 5% offers for the first responses as set in the bonusFor property
        if (bonusCount &lt;= bonusNo) {
            lastPrice = new Double(lastPrice.doubleValue() - lastPrice.doubleValue() * 0.05);
            bonusCount++;
        }

        String discountedPrice = lastPrice.toString();

        mc.getEnvelope().getBody().getFirstElement().getFirstElement().getFirstChildWithName
                (new QName(&quot;http://services.samples/xsd&quot;,&quot;last&quot;)).setText(discountedPrice);

        System.out.println(&quot;Quote value discounted.&quot;);
        System.out.println(&quot;Original price: &quot; + price);
        System.out.println(&quot;Discounted price: &quot; + discountedPrice);

        return true;
    }

    public String getType() {
        return null;
    }

    public void setTraceState(int traceState) {
        traceState = 0;
    }

    public int getTraceState() {
        return 0;
    }

    public void setDiscountFactor(String discount) {
        discountFactor=discount;
    }

    public String getDiscountFactor() {
        return discountFactor;
    }

    public void setBonusFor(String bonus){
        bonusFor=bonus;
    }

    public String getBonusFor(){
        return bonusFor;
    }
}</pre></div>
    <p>
      All classes developed for class mediation should implement the Mediator
      interface, which contains the mediate(...) method. mediate(...) method of
      the above class is invoked for each response message mediated through the
      main sequence, with the message context of the current message as the
      parameter. All the details of the message including the SOAP headers, SOAP
      body and properties of the context hierarchy can be accessed from the
      message context. In this sample, the body of the message is retrieved and
      the discount percentage is subtracted from the quote price. If the quote
      request number is less than the number specified in the &quot;bonusFor&quot;
      property in the configuration, a special discount is given.
    </p>
    <p></p>
    <p>
      Now run the client using the following command.
    </p>
<div><pre>ant stockquote -Dsymbol=IBM -Dmode=quote -Daddurl=http://localhost:8080</pre></div>
    <p>
      You will see the below output in the client console with the discounted
      quote value.
    </p>
<div><pre>[java] Standard :: Stock price = $138.77458254967408</pre></div>
    <p>
      Now check the console running Synapse. You will see the original value and
      the discounted value for the requested quote as follows.
    </p>
<div><pre>Quote value discounted.
Original price: 162.30945327447262
Discounted price: 138.77458254967408</pre></div>
    <p></p>
    <div class="section"><h2>
      <a name="XQuery" id="XQuery">Evaluating XQuery for mediation (XQuery
      Mediator)</a>
    <a name="Evaluating_XQuery_for_mediation_XQuery______Mediator"></a></h2>

    <div class="section"><h2>
      <a name="Sample390" id="Sample390">Sample 390: Introduction to the
      XQuery mediator</a>
    <a name="Sample_390:_Introduction_to_the______XQuery_mediator"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;!-- the SimpleURLRegistry allows access to a URL based registry (e.g. file:/// or http://) --&gt;
    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;localEntry key=&quot;xquery-key-req&quot;
                src=&quot;file:repository/conf/sample/resources/xquery/xquery_req.xq&quot;/&gt;
    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;xquery key=&quot;xquery-key-req&quot;&gt;
                    &lt;variable name=&quot;payload&quot; type=&quot;ELEMENT&quot;/&gt;
                &lt;/xquery&gt;
                &lt;send&gt;
                    &lt;endpoint&gt;
                        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                    &lt;/endpoint&gt;
                &lt;/send&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;out&gt;
                     &lt;xquery key=&quot;xquery/xquery_res.xq&quot;&gt;
                        &lt;variable name=&quot;payload&quot; type=&quot;ELEMENT&quot;/&gt;
                    &lt;/xquery&gt;
                     &lt;send/&gt;
                &lt;/out&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;&lt;/proxy&gt;&lt;/definitions&gt; </pre></div>
    <p></p>
    <p>
      <b>Objective: Introduction transformation using XQuery mediator</b>
    </p>
    <p>
      <b>Prerequisites</b>:Start the Synapse configuration numbered
      390: i.e. synapse -sample 390
    </p>
    <p>
      Start the Axis2 server and deploy the SimpleStockQuoteService if not
      already done.
    </p>
    <p></p>
    <p>
      This example uses the XQuery mediator to perform transformations. This
      sample behaves the same as sample number 8 and the only difference is that
      this sample uses XQuery instead of XSLT for transformation.
    </p>
    <p></p>
    <p>
      Execute the custom quote client as 'ant stockquote -Dmode=customquote ...'
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy -Dmode=customquote </pre></div>
    <p></p>
    <div class="section"><h2>
      <a name="Sample391" id="Sample391">Sample 391: How to use data from an
      external XML document with in XQuery </a>
    <a name="Sample_391:_How_to_use_data_from_an______external_XML_document_with_in_XQuery"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;!-- the SimpleURLRegistry allows access to  URL based registry (e.g. file:/// or http://) --&gt;
    &lt;registry provider=&quot;org.apache.synapse.registry.url.SimpleURLRegistry&quot;&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;parameter name=&quot;root&quot;&gt;file:repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;parameter name=&quot;cachableDuration&quot;&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;proxy name=&quot;StockQuoteProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;send&gt;
                    &lt;endpoint&gt;
                        &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                    &lt;/endpoint&gt;
                &lt;/send&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;out&gt;
                    &lt;xquery key=&quot;xquery/xquery_commisson.xq&quot;&gt;
                        &lt;variable name=&quot;payload&quot; type=&quot;ELEMENT&quot;&gt;&lt;/variable&gt;
                            &lt;variable name=&quot;commission&quot; type=&quot;ELEMENT&quot; key=&quot;misc/commission.xml&quot;&gt;&lt;/variable&gt;
                    &lt;/xquery&gt;
                    &lt;send/&gt;
                &lt;/out&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
        &lt;publishWSDL uri=&quot;file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl&quot;/&gt;&lt;/proxy&gt;&lt;/definitions&gt;   ns&gt;</pre></div>
    <p>
      <b></b>
    </p>
    <p>
      <b><b>Objective: Demonstrate the use of XQuery mediator to
      import external XML documents to the XQuery engine</b></b>
    </p>
    <p>
      <b>Prerequisites:</b>Deploy the SimpleStockQuoteService
      in sample Axis2 server and start it on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 391 (i.e. synapse -sample
      391).
    </p>
    <p>
      In this sample, data from commission.xml document is used inside XQUERY
      document. The stock quote price from the response and commission from the
      commission.xml document will be added and given as a new price .
    </p>
    <p>
      Invoke the client as follows.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/StockQuoteProxy</pre></div>
    <div class="section"><h2>
      <a name="Splitter" id="Splitter">Splitting messages in to parts and
      process in parallel (Iterate / Clone)</a>
    <a name="Splitting_messages_in_to_parts_and______process_in_parallel_Iterate__Clone"></a></h2>

    <div class="section"><h2>
      <a name="Sample400" id="Sample400">Sample 400: Message splitting and
      aggregating the responses</a>
    <a name="Sample_400:_Message_splitting_and______aggregating_the_responses"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;

    &lt;proxy name=&quot;SplitAggregateProxy&quot;&gt;
        &lt;target&gt;
            &lt;inSequence&gt;
                &lt;iterate expression=&quot;//m0:getQuote/m0:request&quot; preservePayload=&quot;true&quot;
                         attachPath=&quot;//m0:getQuote&quot;
                         xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                    &lt;target&gt;
                        &lt;sequence&gt;
                            &lt;send&gt;
                                &lt;endpoint&gt;
                                    &lt;address
                                        uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
                                &lt;/endpoint&gt;
                            &lt;/send&gt;
                        &lt;/sequence&gt;
                    &lt;/target&gt;
                &lt;/iterate&gt;
            &lt;/inSequence&gt;
            &lt;outSequence&gt;
                &lt;aggregate&gt;
                    &lt;onComplete expression=&quot;//m0:getQuoteResponse&quot;
                                xmlns:m0=&quot;http://services.samples/xsd&quot;&gt;
                        &lt;send/&gt;
                    &lt;/onComplete&gt;
                    &lt;invalidate&gt;
                        &lt;log level=&quot;full&quot;/&gt;
                        &lt;drop/&gt;
                    &lt;/invalidate&gt;
                &lt;/aggregate&gt;
            &lt;/outSequence&gt;
        &lt;/target&gt;
    &lt;/proxy&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b><b>Objective: Demonstrate the use of Iterate mediator to
      split the messages in to parts and process them asynchronously and then
      aggregate the responses coming in to synapse</b></b>
    </p>
    <p>
      <b>Prerequisites:</b>Deploy the SimpleStockQuoteService
      in sample Axis2 server and start it on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 400 (i.e. synapse -sample
      400).
    </p>
    <p>
      In this sample, the message sent to synapse has embedded with a number of
      elements of the same type in one message. When synapse received this
      message it will iterate through those elements and then sent to the
      specified endpoint. When all the responses appear in to synapse then those
      messages will be aggregated to form the resultant response and sent back
      to the client.
    </p>
    <p>
      Invoke the client as follows.
    </p>
<div><pre>ant stockquote -Daddurl=http://localhost:8080/soap/SplitAggregateProxy -Ditr=4</pre></div>




    <div class="section"><h2>
      <a name="Cache" id="Cache">Caching the responses over the requests
      (Cache Mediator)</a>
    <a name="Caching_the_responses_over_the_requests______Cache_Mediator"></a></h2>
    <p>
      Cached mediator can be used to utilize the network bandwidth, to protect
      the backend service from being loaded with the same type of requests like
      browser refresh actions and also to speed up the execution of the web
      service. This mediator should be used with sence, because it is not
      applicable for each and every service (for example services with dynamic
      responses for a particular release)
    </p>
    <div class="section"><h2>
      <a name="Sample420" id="Sample420">Sample 420: Simple cache implemented
      on synapse for the actual service</a>
    <a name="Sample_420:_Simple_cache_implemented______on_synapse_for_the_actual_service"></a></h2>
<div><pre>&lt;definitions xmlns=&quot;http://ws.apache.org/ns/synapse&quot;&gt;
    &lt;in&gt;
        &lt;cache timeout=&quot;20000&quot; scope=&quot;per-host&quot;
               hashGenerator=&quot;org.wso2.caching.digest.DOMHASHGenerator&quot;&gt;
            &lt;implementation type=&quot;memory&quot; maxSize=&quot;100&quot;/&gt;
        &lt;/cache&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot;/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;cache/&gt;
        &lt;send/&gt;
    &lt;/out&gt;
&lt;/definitions&gt;</pre></div>
    <p>
      <b><b>Objective: Demonstrate the use of Cache mediator in order
      to cache the response and use that cached response as the response for an
      identical xml request</b></b>
    </p>
    <p>
      <b>Prerequisites:</b>Deploy the SimpleStockQuoteService
      in sample Axis2 server and start it on port 9000.
    </p>
    <p>
      Start Synapse with the sample configuration 420 (i.e. synapse -sample
      420).
    </p>
    <p>
      In this sample, the message sent to synapse is checked for an existing
      cached response by calculating the hash value of the request. If there is
      a cache hit in synapse then this request will not be forwarded to the
      actual service, rather synapse respond to the client with the cached
      response. In case of a cache miss that particular message will be
      forwarded to the actual service and cached that response in the out path
      for the use of consecutive requests of the same type.
    </p>
    <p>
      To observe this behaviour, invoke the client as follows.
    </p>
<div><pre>ant stockquote -Dtrpurl=http://localhost:8080/</pre></div>
    <p>
      You could notice that if you send more than one requests within 20 seconds
      only the first request is forwarded to the actual service, and the rest of
      the requests will be served by the cache inside Synapse. You could observe
      this by looking at the printed line of the axis2 server, as well as by
      observing a constant rate as the response to the client instead of the
      random rate, which changes by each and every 20 seconds.
    </p>
    <p>
      &#160;
    </p>
    <p>
      &#160;
    </p>
  
</html>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2005-2012
                        <a href="http://www.apache.org/">Apache Software Foundation</a>.
            All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
